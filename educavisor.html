<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de An√°lise de Pesquisa Educacional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 50%, #8DA9C4 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header-white-box {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border: 3px solid rgba(255,255,255,0.2);
        }

        .header-white-box h1 {
            color: #1C355E;
            margin: 0;
            text-shadow: none;
        }

        .header-white-box .subtitle {
            color: #2F5F9E;
            font-size: 1.5rem;
            margin: 15px 0 0 0;
            text-shadow: none;
            font-weight: 600;
        }

        .header-logo {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .logo-image {
            max-width: 140px;
            width: 100%;
            height: auto;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }

        .logo-image:hover {
            transform: scale(1.05);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section.minimized {
            padding: 15px;
            margin-bottom: 20px;
        }

        .upload-section.minimized h2 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .upload-section.minimized p {
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: linear-gradient(45deg, #1C355E, #2F5F9E);
            color: #FFFFFF;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(28, 53, 94, 0.3);
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1C355E;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .hover-card {
            cursor: pointer;
            position: relative;
        }

        .hover-card .hover-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .hover-card:hover .hover-icon {
            opacity: 1;
        }

        .hover-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 50%, #6A5ACD 100%);
            color: #FFFFFF;
            padding: 20px;
            border-radius: 15px;
            font-size: 0.95rem;
            line-height: 1.6;
            z-index: 1000;
            min-width: 280px;
            max-width: 380px;
            box-shadow: 0 15px 35px rgba(28, 53, 94, 0.3), 0 5px 15px rgba(28, 53, 94, 0.2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            will-change: opacity, visibility, transform;
        }

        .hover-tooltip.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .hover-tooltip::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #1C355E;
            filter: drop-shadow(0 -2px 4px rgba(28, 53, 94, 0.2));
        }

        .tooltip-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 12px;
            color: #fff;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 8px;
        }

        .tooltip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tooltip-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .tooltip-label {
            flex: 1;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .tooltip-value {
            font-weight: bold;
            font-size: 0.95rem;
            margin-left: 10px;
            background: rgba(255,255,255,0.15);
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 50px;
            text-align: center;
        }

        .tooltip-total {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid rgba(255,255,255,0.2);
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            color: #fff;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1C355E;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(28, 53, 94, 0.2);
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .insights-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .insight-item {
            background: linear-gradient(135deg, #f8faff 0%, #CBD7E6 100%);
            border-left: 4px solid #1C355E;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 2px 8px rgba(28, 53, 94, 0.1);
        }

        .insight-item h4 {
            color: #1C355E;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 100%);
            color: #FFFFFF;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .table tr:hover {
            background: #f5f5f5;
        }

        .report-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .download-btn {
            background: linear-gradient(45deg, #1C355E, #2F5F9E);
            color: #FFFFFF;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(28, 53, 94, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .generate-report-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: #FFFFFF;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            font-weight: bold;
        }

        .generate-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .logout-btn {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: #FFFFFF;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            font-weight: bold;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            background: linear-gradient(45deg, #c82333, #a71e2a);
        }

        .file-status {
            margin-top: 15px;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            color: #155724;
            display: none;
        }

        .footer-section {
            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 100%);
            color: #FFFFFF;
            padding: 30px 0;
            margin-top: 50px;
            text-align: center;
            box-shadow: 0 -5px 20px rgba(28, 53, 94, 0.2);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .footer-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .copyright {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            color: #ecf0f1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .developer {
            font-size: 0.9rem;
            margin: 0;
            color: #bdc3c7;
            font-style: italic;
        }

        .footer-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6A5ACD 0%, #1C355E 100%);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .header-white-box {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header-white-box h1 {
                font-size: 2rem;
            }

            .header-white-box .subtitle {
                font-size: 1.3rem;
            }

            .header-logo {
                flex-direction: column;
                gap: 15px;
            }

            .logo-image {
                max-width: 100px;
            }

            .footer-section {
                padding: 20px 0;
                margin-top: 30px;
            }

            .copyright {
                font-size: 0.9rem;
            }

            .developer {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .header-white-box {
                padding: 15px;
            }
            
            .logo-image {
                max-width: 80px;
            }
            
            .header-white-box h1 {
                font-size: 1.8rem;
            }

            .header-white-box .subtitle {
                font-size: 1.2rem;
            }
        }

        @media (min-width: 1200px) {
            .logo-image {
                max-width: 160px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-white-box">
                <div class="header-logo">
                    <img src="https://i.ibb.co/Ld7f2SqF/educavisor.png" alt="EDUCAVISOR Logo" class="logo-image">
                    <h1>EDUCAVISOR - Conselho em Dados</h1>
                </div>
                <h2 class="subtitle">Relat√≥rio Anal√≠tico dos Resultados do Pr√©-Conselho Escolar</h2>
            </div>
            
            <div id="headerInfo" style="display: none; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 20px 0; text-align: left; backdrop-filter: blur(10px);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div>
                        <strong>üè´ Unidade Escolar:</strong><br>
                        <span id="unidadeEscolar">-</span>
                    </div>
                    <div>
                        <strong>üë• Turmas Avaliadas:</strong><br>
                        <span id="turmasAvaliadas">-</span>
                    </div>
                    <div>
                        <strong>üìÖ Per√≠odo de Aplica√ß√£o:</strong><br>
                        <span id="periodoAplicacao">-</span>
                    </div>
                    <div>
                        <strong>üë®‚Äçüíº Respons√°vel T√©cnico:</strong><br>
                        <span>Gestor Pedag√≥gico</span>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-size: 0.95rem; line-height: 1.6;">
                    <p style="margin: 0;">Este relat√≥rio apresenta os principais dados coletados junto aos estudantes, professores e demais envolvidos no processo pedag√≥gico, com base nas respostas do instrumento aplicado no contexto do Pr√©-Conselho Escolar.</p>
                </div>
            </div>
            
            <div id="uploadPrompt">
                <p>Fa√ßa upload do arquivo CSV da pesquisa para gerar relat√≥rios autom√°ticos</p>
            </div>
            
            <div id="logoutSection" style="display: none; text-align: center; margin-top: 20px;">
                <button id="logoutBtn" class="logout-btn">
                    üö™ Desconectar Dados
                </button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Clique para limpar os dados e carregar um novo arquivo
                </p>
            </div>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>üìÅ Upload do Arquivo CSV</h2>
            <p>Selecione o arquivo CSV da pesquisa educacional para an√°lise</p>
            
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" class="file-input" accept=".csv,text/csv,application/vnd.ms-excel" />
                <label for="csvFile" class="file-input-button">
                    Escolher Arquivo CSV
                </label>
            </div>
            
            <div class="file-status" id="fileStatus">
                <!-- Status do arquivo ser√° mostrado aqui -->
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando dados...</p>
            </div>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="stats-grid" id="statsGrid">
                <!-- Cards de estat√≠sticas ser√£o inseridos aqui -->
            </div>

            <div class="charts-grid" id="chartsGrid">
                <!-- Gr√°ficos ser√£o inseridos aqui -->
            </div>

            <div class="insights-section">
                <h2 class="insights-title">üéØ Filtros de An√°lise</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="text-align: center;">
                        <label for="turmaSelect" style="font-size: 1.1rem; font-weight: bold; margin-right: 15px; display: block; margin-bottom: 10px;">üìö Filtrar por Turma:</label>
                        <select id="turmaSelect" style="padding: 10px 15px; font-size: 1rem; border: 2px solid #1C355E; border-radius: 8px; background: white; cursor: pointer; box-shadow: 0 2px 8px rgba(28, 53, 94, 0.1); width: 100%; max-width: 250px;">
                            <option value="">-- Todas as Turmas --</option>
                        </select>
                    </div>
                    <div style="text-align: center;">
                        <label for="disciplinaSelect" style="font-size: 1.1rem; font-weight: bold; margin-right: 15px; display: block; margin-bottom: 10px;">üìñ Analisar Disciplina:</label>
                        <select id="disciplinaSelect" style="padding: 10px 15px; font-size: 1rem; border: 2px solid #1C355E; border-radius: 8px; background: white; cursor: pointer; box-shadow: 0 2px 8px rgba(28, 53, 94, 0.1); width: 100%; max-width: 250px;">
                            <option value="">-- Escolha uma disciplina --</option>
                        </select>
                    </div>
                </div>
                <div id="filtroInfo" style="display: none; text-align: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #e8f2ff 0%, #f0f8ff 100%); border-radius: 10px; border-left: 4px solid #1C355E;">
                    <p style="margin: 0; font-size: 1.1rem; color: #1C355E; font-weight: bold;">
                        <span id="filtroTexto">Visualizando dados filtrados</span>
                    </p>
                </div>
                <div id="disciplinaCharts" style="display: none;">
                    <div class="charts-grid" id="disciplinaChartsGrid">
                        <!-- Gr√°ficos da disciplina selecionada ser√£o inseridos aqui -->
                    </div>
                </div>
            </div>

            <div class="insights-section">
                <h2 class="insights-title">üí° Insights Principais</h2>
                <div id="insightsContainer">
                    <!-- Insights ser√£o inseridos aqui -->
                </div>
            </div>

            <div class="insights-section">
                <h2 class="insights-title">üí¨ An√°lise Qualitativa das Percep√ß√µes Estudantis</h2>
                <div id="comentariosContainer">
                    <!-- Coment√°rios ser√£o inseridos aqui -->
                </div>
            </div>

            <div class="data-table">
                <h2 class="chart-title">üìã Dados Detalhados</h2>
                <div id="tableContainer">
                    <!-- Tabela ser√° inserida aqui -->
                </div>
            </div>

            <div class="report-section">
                <h2 class="chart-title">üìÑ Relat√≥rio Executivo</h2>
                <div id="reportContent">
                    <!-- Relat√≥rio ser√° inserido aqui -->
                </div>
            </div>

            <div class="insights-section" style="text-align: center; margin-top: 60px; margin-bottom: 120px;">
                <button id="generateReportBtn" class="generate-report-btn">
                    üìä Gerar Relat√≥rio Completo
                </button>
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                    Clique para abrir o relat√≥rio completo em uma nova aba
                </p>
            </div>

        </div>
    </div>

    <footer class="footer-section">
        <div class="footer-content">
            <div class="footer-info">
                <p class="copyright">¬© 2025 Luiz Alessandro Tecnologia Educacional. Todos os direitos reservados</p>
                <p class="developer">Desenvolvido por Luiz Alessandro da Silva.</p>
            </div>
        </div>
    </footer>

    <script>
        let csvData = [];
        let processedData = {};
        let currentFilter = { turma: '', disciplina: '' };

        function extractHeaderInfo(fileName) {
            console.log('Extraindo informa√ß√µes do cabe√ßalho para arquivo:', fileName);
            
            // Remover extens√£o do arquivo
            const nomeArquivo = fileName.replace(/\.(csv|CSV)$/, '');
            console.log('Nome do arquivo sem extens√£o:', nomeArquivo);
            
            let unidadeEscolar = 'N√£o identificada';
            let turmas = 'N√£o identificada';
            
            // Verificar se existe h√≠fen no nome do arquivo
            if (nomeArquivo.includes(' - ')) {
                // Dividir pelo padr√£o " - " (espa√ßo-h√≠fen-espa√ßo)
                const partes = nomeArquivo.split(' - ');
                unidadeEscolar = partes[0].trim();
                turmas = partes[1] ? partes[1].trim() : 'N√£o identificada';
                console.log('Unidade Escolar extra√≠da:', unidadeEscolar);
                console.log('Turma extra√≠da:', turmas);
            } else {
                // Se n√£o houver h√≠fen, usar o nome completo como unidade escolar
                unidadeEscolar = nomeArquivo;
                console.log('Usando nome completo como unidade escolar:', unidadeEscolar);
            }
            
            // Extrair per√≠odo das datas dos carimbos de data/hora
            console.log('Procurando carimbos de data/hora nos dados...');
            
            // Verificar diferentes poss√≠veis nomes de colunas de timestamp
            const possibleTimestampColumns = [
                'Carimbo de data/hora',
                'Timestamp',
                'Data/Hora',
                'Data e Hora',
                'Carimbo de data e hora'
            ];
            
            let timestampColumn = null;
            for (const col of possibleTimestampColumns) {
                if (csvData.length > 0 && csvData[0].hasOwnProperty(col)) {
                    timestampColumn = col;
                    console.log('Coluna de timestamp encontrada:', col);
                    break;
                }
            }
            
            let periodoAplicacao = 'N√£o identificado';
            
            if (timestampColumn && csvData.length > 0) {
                const carimbos = csvData
                    .map(row => row[timestampColumn])
                    .filter(carimbo => carimbo && carimbo.trim())
                    .map(carimbo => {
                        console.log('Processando carimbo:', carimbo);
                        let date = null;
                        
                        // Extrair apenas a parte da data (antes do espa√ßo)
                        const datePart = carimbo.split(' ')[0];
                        console.log('Parte da data extra√≠da:', datePart);
                        
                        // Formato MM/DD/AAAA (formato americano)
                        if (datePart.includes('/')) {
                            const parts = datePart.split('/');
                            if (parts.length === 3) {
                                const month = parseInt(parts[0]);
                                const day = parseInt(parts[1]);
                                const year = parseInt(parts[2]);
                                
                                console.log(`Convertendo: M√™s=${month}, Dia=${day}, Ano=${year}`);
                                
                                // Criar data no formato correto (ano, m√™s-1, dia)
                                date = new Date(year, month - 1, day);
                                console.log('Data criada:', date);
                            }
                        }
                        
                        return date && !isNaN(date.getTime()) ? date : null;
                    })
                    .filter(date => date !== null)
                    .sort((a, b) => a - b);
                
                console.log('Carimbos processados:', carimbos.length);
                
                if (carimbos.length > 0) {
                    const dataInicio = carimbos[0].toLocaleDateString('pt-BR');
                    const dataFim = carimbos[carimbos.length - 1].toLocaleDateString('pt-BR');
                    
                    console.log('Data in√≠cio:', dataInicio);
                    console.log('Data fim:', dataFim);
                    
                    if (dataInicio === dataFim) {
                        periodoAplicacao = dataInicio;
                    } else {
                        periodoAplicacao = `${dataInicio} a ${dataFim}`;
                    }
                    console.log('Per√≠odo de aplica√ß√£o final:', periodoAplicacao);
                }
            } else {
                console.log('Nenhuma coluna de timestamp encontrada ou dados vazios');
            }
            
            // Atualizar elementos do cabe√ßalho
            const unidadeElement = document.getElementById('unidadeEscolar');
            const turmasElement = document.getElementById('turmasAvaliadas');
            const periodoElement = document.getElementById('periodoAplicacao');
            
            if (unidadeElement) {
                unidadeElement.textContent = unidadeEscolar;
                console.log('Unidade escolar atualizada no DOM');
            }
            if (turmasElement) {
                turmasElement.textContent = turmas;
                console.log('Turmas atualizadas no DOM');
            }
            if (periodoElement) {
                periodoElement.textContent = periodoAplicacao;
                console.log('Per√≠odo atualizado no DOM');
            }
        }



        // Configurar evento do bot√£o de logout quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            setupLogoutButton();
        });

        // Fun√ß√£o para configurar o bot√£o de logout
        function setupLogoutButton() {
            console.log('üîß Configurando bot√£o de logout...');
            
            // Usar delega√ß√£o de eventos para garantir que funcione mesmo ap√≥s mudan√ßas no DOM
            document.addEventListener('click', function(event) {
                if (event.target && event.target.id === 'logoutBtn') {
                    console.log('üî¥ Bot√£o desconectar clicado via delega√ß√£o');
                    event.preventDefault();
                    
                    // Confirmar a√ß√£o
                    if (confirm('Tem certeza que deseja desconectar os dados? Todos os dados carregados ser√£o perdidos.')) {
                        console.log('‚úÖ Usu√°rio confirmou desconex√£o');
                        logoutData();
                    } else {
                        console.log('‚ùå Usu√°rio cancelou desconex√£o');
                    }
                }
            });
            
            console.log('‚úÖ Delega√ß√£o de eventos configurada para bot√£o logout');
        }

        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('‚ùå Nenhum arquivo selecionado');
                return;
            }

            console.log('=== DIAGN√ìSTICO COMPLETO DO ARQUIVO ===');
            console.log('üìÅ Nome do arquivo:', file.name);
            console.log('üìÑ Tipo MIME:', file.type || 'n√£o detectado');
            console.log('üìè Tamanho:', file.size, 'bytes');
            console.log('üìÖ √öltima modifica√ß√£o:', new Date(file.lastModified).toLocaleString('pt-BR'));
            
            // Verificar extens√£o do arquivo
            const fileName = file.name.toLowerCase();
            const hasCSVExtension = fileName.endsWith('.csv');
            
            console.log('üîç Extens√£o .csv detectada:', hasCSVExtension);
            
            // Aceitar arquivos com extens√£o .csv independente do tipo MIME
            if (!hasCSVExtension) {
                console.error('‚ùå Arquivo n√£o √© CSV');
                alert('Por favor, selecione um arquivo com extens√£o .csv');
                return;
            }

            console.log('‚úÖ Arquivo CSV aceito para processamento');
            
            // Mostrar loading
            const loadingElement = document.getElementById('loading');
            const fileStatusElement = document.getElementById('fileStatus');
            
            loadingElement.style.display = 'block';
            fileStatusElement.style.display = 'none';
            
            // Criar FileReader
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    console.log('=== AN√ÅLISE DO CONTE√öDO ===');
                    console.log('üìä Total de caracteres:', content.length);
                    
                    if (content.length === 0) {
                        throw new Error('Arquivo est√° vazio');
                    }
                    
                    // Mostrar amostra do conte√∫do
                    const firstLines = content.split('\n').slice(0, 3);
                    console.log('üìã Primeiras 3 linhas:');
                    firstLines.forEach((line, index) => {
                        console.log(`Linha ${index + 1}:`, line.substring(0, 100) + (line.length > 100 ? '...' : ''));
                    });
                    
                    // Detectar delimitador automaticamente
                    const firstLine = content.split('\n')[0];
                    const commaCount = (firstLine.match(/,/g) || []).length;
                    const semicolonCount = (firstLine.match(/;/g) || []).length;
                    const tabCount = (firstLine.match(/\t/g) || []).length;
                    
                    console.log('üîç An√°lise de delimitadores na primeira linha:');
                    console.log('   V√≠rgulas (,):', commaCount);
                    console.log('   Ponto e v√≠rgulas (;):', semicolonCount);
                    console.log('   Tabs (\\t):', tabCount);
                    
                    let delimiter = ','; // padr√£o
                    if (semicolonCount > commaCount && semicolonCount > tabCount) {
                        delimiter = ';';
                    } else if (tabCount > commaCount && tabCount > semicolonCount) {
                        delimiter = '\t';
                    }
                    
                    console.log('‚úÖ Delimitador escolhido:', delimiter === '\t' ? '\\t (tab)' : delimiter);
                    
                    // Configurar Papa Parse com op√ß√µes robustas
                    const parseConfig = {
                        header: true,
                        skipEmptyLines: 'greedy',
                        delimiter: delimiter,
                        encoding: 'UTF-8',
                        dynamicTyping: false, // Manter tudo como string inicialmente
                        transformHeader: function(header) {
                            const cleaned = header.trim().replace(/^\uFEFF/, ''); // Remove BOM se presente
                            console.log('üè∑Ô∏è Cabe√ßalho processado:', `"${header}" ‚Üí "${cleaned}"`);
                            return cleaned;
                        },
                        transform: function(value, header) {
                            // Limpar valores e remover aspas extras
                            if (typeof value === 'string') {
                                return value.trim().replace(/^["']|["']$/g, '');
                            }
                            return value;
                        },
                        complete: function(results) {
                            console.log('=== RESULTADO DO PAPA PARSE ===');
                            console.log('üìä Total de linhas processadas:', results.data.length);
                            console.log('‚ö†Ô∏è Erros encontrados:', results.errors.length);
                            console.log('üìã Colunas detectadas:', results.meta.fields?.length || 0);
                            
                            if (results.errors.length > 0) {
                                console.log('‚ùå Detalhes dos erros:');
                                results.errors.forEach((error, index) => {
                                    console.log(`   Erro ${index + 1}:`, error);
                                });
                            }
                            
                            if (results.meta.fields) {
                                console.log('üìù Lista de colunas:');
                                results.meta.fields.forEach((field, index) => {
                                    console.log(`   ${index + 1}. "${field}"`);
                                });
                            }
                            
                            // Verificar se temos dados
                            if (!results.data || results.data.length === 0) {
                                throw new Error('Nenhuma linha de dados foi encontrada no arquivo');
                            }
                            
                            // Mostrar amostra dos dados
                            console.log('üìã Amostra dos dados (primeiras 2 linhas):');
                            results.data.slice(0, 2).forEach((row, index) => {
                                console.log(`   Linha ${index + 1}:`, row);
                            });
                            
                            // Armazenar dados globalmente
                            csvData = results.data;
                            
                            // Processar os dados
                            console.log('=== INICIANDO PROCESSAMENTO DOS DADOS ===');
                            processData();
                            
                            if (processedData.totalRespostas === 0) {
                                throw new Error('Nenhuma resposta v√°lida foi encontrada ap√≥s o processamento. Verifique se as colunas est√£o no formato esperado.');
                            }
                            
                            console.log('‚úÖ Processamento conclu√≠do com sucesso!');
                            console.log('üìä Total de respostas v√°lidas:', processedData.totalRespostas);
                            
                            // Extrair informa√ß√µes do cabe√ßalho do arquivo
                            extractHeaderInfo(file.name);
                            
                            // Gerar o dashboard
                            generateDashboard();
                            
                            // Atualizar a interface
                            updateInterface(file.name);
                            
                            // Bot√£o de logout j√° configurado via delega√ß√£o de eventos
                            
                        },
                        error: function(error) {
                            throw new Error('Erro do Papa Parse: ' + error.message);
                        }
                    };
                    
                    // Executar o parsing
                    console.log('üöÄ Iniciando parsing com Papa Parse...');
                    Papa.parse(content, parseConfig);
                    
                } catch (error) {
                    console.error('‚ùå ERRO CR√çTICO:', error.message);
                    console.error('üìç Stack trace:', error.stack);
                    
                    loadingElement.style.display = 'none';
                    
                    alert(`Erro ao processar o arquivo CSV:\n\n${error.message}\n\nVerifique o console (F12) para mais detalhes e certifique-se de que:\n‚Ä¢ O arquivo √© um CSV v√°lido\n‚Ä¢ Cont√©m dados nas colunas esperadas\n‚Ä¢ N√£o est√° corrompido`);
                }
            };
            
            reader.onerror = function(error) {
                console.error('‚ùå Erro ao ler o arquivo:', error);
                loadingElement.style.display = 'none';
                alert('Erro ao ler o arquivo. Verifique se o arquivo n√£o est√° corrompido e tente novamente.');
            };
            
            // Ler o arquivo como texto UTF-8
            console.log('üìñ Iniciando leitura do arquivo...');
            reader.readAsText(file, 'UTF-8');
        });

        function updateInterface(fileName) {
            const uploadSection = document.getElementById('uploadSection');
            const fileStatus = document.getElementById('fileStatus');
            const headerInfo = document.getElementById('headerInfo');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const loadingElement = document.getElementById('loading');
            const dashboard = document.getElementById('dashboard');
            const logoutSection = document.getElementById('logoutSection');
            
            // Minimizar se√ß√£o de upload
            uploadSection.classList.add('minimized');
            
            // Mostrar status do arquivo
            fileStatus.style.display = 'block';
            fileStatus.innerHTML = `‚úÖ Arquivo carregado com sucesso: <strong>${fileName}</strong><br>üìä ${processedData.totalRespostas} respostas v√°lidas processadas`;
            
            // Mostrar informa√ß√µes do cabe√ßalho
            headerInfo.style.display = 'block';
            
            // Ocultar prompt de upload
            uploadPrompt.style.display = 'none';
            
            // Mostrar bot√£o de logout
            logoutSection.style.display = 'block';
            
            // Ocultar loading
            loadingElement.style.display = 'none';
            
            // Mostrar dashboard
            dashboard.style.display = 'block';
            
            console.log('‚úÖ Interface atualizada com sucesso!');
        }



        function logoutData() {
            console.log('üöÄ Iniciando processo de desconex√£o de dados...');
            
            try {
                // Limpar dados globais
                csvData = [];
                processedData = {};
                console.log('üìä Dados globais limpos');
                
                // Resetar elementos da interface
                const uploadSection = document.getElementById('uploadSection');
                const fileStatus = document.getElementById('fileStatus');
                const headerInfo = document.getElementById('headerInfo');
                const uploadPrompt = document.getElementById('uploadPrompt');
                const loadingElement = document.getElementById('loading');
                const dashboard = document.getElementById('dashboard');
                const logoutSection = document.getElementById('logoutSection');
                const csvFileInput = document.getElementById('csvFile');
                
                console.log('üîç Elementos da interface localizados');
                
                // Restaurar se√ß√£o de upload
                if (uploadSection) {
                    uploadSection.classList.remove('minimized');
                    console.log('üì§ Se√ß√£o de upload restaurada');
                }
                
                // Ocultar status do arquivo
                if (fileStatus) {
                    fileStatus.style.display = 'none';
                    fileStatus.innerHTML = '';
                    console.log('üìÑ Status do arquivo ocultado');
                }
                
                // Ocultar informa√ß√µes do cabe√ßalho
                if (headerInfo) {
                    headerInfo.style.display = 'none';
                    console.log('üìã Informa√ß√µes do cabe√ßalho ocultadas');
                }
                
                // Mostrar prompt de upload
                if (uploadPrompt) {
                    uploadPrompt.style.display = 'block';
                    console.log('üí¨ Prompt de upload exibido');
                }
                
                // Ocultar bot√£o de logout
                if (logoutSection) {
                    logoutSection.style.display = 'none';
                    console.log('üö™ Se√ß√£o de logout ocultada');
                }
                
                // Ocultar loading
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                    console.log('‚è≥ Loading ocultado');
                }
                
                // Ocultar dashboard
                if (dashboard) {
                    dashboard.style.display = 'none';
                    console.log('üìä Dashboard ocultado');
                }
                
                // Limpar input de arquivo
                if (csvFileInput) {
                    csvFileInput.value = '';
                    console.log('üìÅ Input de arquivo limpo');
                }
                
                // Limpar conte√∫do dos containers
                const containers = [
                    'statsGrid', 'chartsGrid', 'disciplinaChartsGrid', 
                    'insightsContainer', 'comentariosContainer', 
                    'tableContainer', 'reportContent'
                ];
                
                containers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = '';
                        console.log(`üßπ Container ${containerId} limpo`);
                    }
                });
                
                // Resetar seletores
                const disciplinaSelect = document.getElementById('disciplinaSelect');
                if (disciplinaSelect) {
                    disciplinaSelect.innerHTML = '<option value="">-- Escolha uma disciplina --</option>';
                    console.log('üìö Seletor de disciplinas resetado');
                }
                
                const turmaSelect = document.getElementById('turmaSelect');
                if (turmaSelect) {
                    turmaSelect.innerHTML = '<option value="">-- Todas as Turmas --</option>';
                    console.log('üéØ Seletor de turmas resetado');
                }
                
                // Resetar filtros
                currentFilter = { turma: '', disciplina: '' };
                console.log('üîÑ Filtros resetados');
                
                // Ocultar gr√°ficos de disciplinas e informa√ß√µes de filtro
                const disciplinaCharts = document.getElementById('disciplinaCharts');
                if (disciplinaCharts) {
                    disciplinaCharts.style.display = 'none';
                    console.log('üìà Gr√°ficos de disciplinas ocultados');
                }
                
                const filtroInfo = document.getElementById('filtroInfo');
                if (filtroInfo) {
                    filtroInfo.style.display = 'none';
                    console.log('‚ÑπÔ∏è Informa√ß√µes de filtro ocultadas');
                }
                
                // Resetar informa√ß√µes do cabe√ßalho
                const headerElements = [
                    { id: 'unidadeEscolar', value: '-' },
                    { id: 'turmasAvaliadas', value: '-' },
                    { id: 'periodoAplicacao', value: '-' }
                ];
                
                headerElements.forEach(element => {
                    const el = document.getElementById(element.id);
                    if (el) {
                        el.textContent = element.value;
                        console.log(`üè∑Ô∏è ${element.id} resetado para "${element.value}"`);
                    }
                });
                
                console.log('‚úÖ Processo de desconex√£o conclu√≠do com sucesso!');
                
                // Mostrar mensagem de confirma√ß√£o
                alert('‚úÖ Dados desconectados com sucesso!\n\nVoc√™ pode agora carregar um novo arquivo CSV.');
                
            } catch (error) {
                console.error('‚ùå Erro durante a desconex√£o:', error);
                alert('‚ùå Erro ao desconectar dados. Recarregue a p√°gina se necess√°rio.');
            }
        }

        function processData(filtroTurma = '') {
            console.log('üîÑ Processando dados com filtro de turma:', filtroTurma || 'Todas as turmas');
            
            // Filtrar dados v√°lidos (ignorar cabe√ßalho e linhas vazias)
            let validData = csvData.filter(row => {
                // Verificar se a linha tem pelo menos um campo preenchido que n√£o seja cabe√ßalho
                const hasValidData = Object.values(row).some(value => 
                    value && value.trim() && 
                    !value.includes('FREQU√äNCIA NAS AULAS') && 
                    !value.includes('PARTICIPA√á√ÉO NAS AULAS')
                );
                return hasValidData;
            });

            console.log(`üìä Total de dados v√°lidos antes do filtro: ${validData.length}`);

            // Aplicar filtro de turma se especificado
            if (filtroTurma && filtroTurma.trim()) {
                const dadosAntesFiltro = validData.length;
                validData = validData.filter(row => {
                    // Buscar coluna de turma com diferentes poss√≠veis nomes
                    const turmaAluno = row['Turma'] || row['TURMA'] || row['turma'] || 
                                     row['6 Turma'] || row['6 TURMA'] || row['6 turma'] ||
                                     row['Qual a sua turma?'] || row['QUAL A SUA TURMA?'] || '';
                    
                    const turmaComparar = turmaAluno ? turmaAluno.trim() : '';
                    const filtroComparar = filtroTurma.trim();
                    
                    console.log(`üîç Comparando: "${turmaComparar}" === "${filtroComparar}"`);
                    
                    return turmaComparar === filtroComparar;
                });
                console.log(`üìä Dados ap√≥s filtro de turma "${filtroTurma}": ${validData.length} registros (eram ${dadosAntesFiltro})`);
                
                if (validData.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum dado encontrado para a turma selecionada!');
                }
            }
            
            processedData = {
                totalRespostas: validData.length,
                frequenciaAulas: {},
                participacaoAulas: {},
                respeitoColegas: {},
                respeitoProfessores: {},
                avaliacaoTurma: {},
                avaliacaoEscola: {},
                disciplinas: {},
                segundoProfessor: {
                    inclusao: {},
                    lideranca: {},
                    frequencia: {}
                },
                comentarios: {
                    sentimentos: [],
                    situacoesProfessores: []
                },
                turmas: {},
                filtroAtivo: filtroTurma
            };

            validData.forEach(row => {
                // Coletar informa√ß√µes de turma - buscar em diferentes poss√≠veis nomes de coluna
                const turmaAluno = row['Turma'] || row['TURMA'] || row['turma'] || 
                                 row['6 Turma'] || row['6 TURMA'] || row['6 turma'] ||
                                 row['Qual a sua turma?'] || row['QUAL A SUA TURMA?'] || 'N√£o informada';
                if (turmaAluno && turmaAluno.trim() && turmaAluno !== 'N√£o informada') {
                    const turmaNormalizada = turmaAluno.trim();
                    processedData.turmas[turmaNormalizada] = (processedData.turmas[turmaNormalizada] || 0) + 1;
                }

                // Processar frequ√™ncia nas aulas
                const freq = row['1a FREQU√äNCIA NAS AULAS SEMANAIS (como est√° sua frequ√™ncia nas aulas?)'];
                if (freq) {
                    processedData.frequenciaAulas[freq] = (processedData.frequenciaAulas[freq] || 0) + 1;
                }

                // Processar participa√ß√£o nas aulas
                const part = row['1b PARTICIPA√á√ÉO NAS AULAS ( como voc√™ avalia seu desempenho escolar?)'];
                if (part) {
                    processedData.participacaoAulas[part] = (processedData.participacaoAulas[part] || 0) + 1;
                }

                // Processar respeito aos colegas
                const respCol = row['1c RESPEITO AOS COLEGAS DE SALA (como est√° o seu respeito com os estudantes da sua turma?)'];
                if (respCol) {
                    processedData.respeitoColegas[respCol] = (processedData.respeitoColegas[respCol] || 0) + 1;
                }

                // Processar respeito aos professores
                const respProf = row['1d RESPEITO AOS PROFESSORES (como est√° o seu respeito para com os professores?)'];
                if (respProf) {
                    processedData.respeitoProfessores[respProf] = (processedData.respeitoProfessores[respProf] || 0) + 1;
                }

                // Processar avalia√ß√£o da turma
                const avalTurma = row['1e SOBRE A SUA TURMA (como voc√™ avalia a sua turma)'];
                if (avalTurma) {
                    processedData.avaliacaoTurma[avalTurma] = (processedData.avaliacaoTurma[avalTurma] || 0) + 1;
                }

                // Processar avalia√ß√£o da escola
                const avalEscola = row['1f SOBRE A ESCOLA HON√ìRIO MIRANDA (como voc√™ se sente sendo estudante dessa escola?)'];
                if (avalEscola) {
                    processedData.avaliacaoEscola[avalEscola] = (processedData.avaliacaoEscola[avalEscola] || 0) + 1;
                }

                // Processar disciplinas com nomes corretos
                const disciplinas = {
                    '3a': 'ARTE',
                    '3b': 'BIOLOGIA', 
                    '3c': 'EDUCA√á√ÉO F√çSICA',
                    '3d': 'ESPANHOL',
                    '3e': 'FILOSOFIA',
                    '3f': 'F√çSICA',
                    '3g': 'GEOGRAFIA',
                    '3h': 'HIST√ìRIA',
                    '3i': 'INGL√äS',
                    '3j': 'L√çNGUA PORTUGUESA',
                    '3k': 'MATEM√ÅTICA',
                    '3L': 'QU√çMICA',
                    '3m': 'SOCIOLOGIA'
                };

                Object.keys(disciplinas).forEach(disc => {
                    const afinidade = row[`${disc}1 AFINIDADE COM A DISCIPLINA (como voc√™ se considera nas aulas desse componente curricular?)`];
                    const didatica = row[`${disc}2 DID√ÅTICA DO PROFESSOR (organiza√ß√£o da aula, tira d√∫vidas, explica√ß√£o, conhecimento do conte√∫do)`];
                    const frequencia = row[`${disc}3 FREQU√äNCIA DO PROFESSOR (raramente falta ou se atrasa)`];
                    const devolutiva = row[`${disc}4 DEVOLUTIVA DAS AVALIA√á√ïES (postagem das notas no estudante online e entrega das corre√ß√µes dentro de um prazo de 15 dias)`];
                    
                    if (afinidade || didatica || frequencia || devolutiva) {
                        if (!processedData.disciplinas[disc]) {
                            processedData.disciplinas[disc] = {
                                nome: disciplinas[disc],
                                afinidade: {},
                                didatica: {},
                                frequencia: {},
                                devolutiva: {}
                            };
                        }
                        
                        if (afinidade) {
                            processedData.disciplinas[disc].afinidade[afinidade] = (processedData.disciplinas[disc].afinidade[afinidade] || 0) + 1;
                        }
                        if (didatica) {
                            processedData.disciplinas[disc].didatica[didatica] = (processedData.disciplinas[disc].didatica[didatica] || 0) + 1;
                        }
                        if (frequencia) {
                            processedData.disciplinas[disc].frequencia[frequencia] = (processedData.disciplinas[disc].frequencia[frequencia] || 0) + 1;
                        }
                        if (devolutiva) {
                            processedData.disciplinas[disc].devolutiva[devolutiva] = (processedData.disciplinas[disc].devolutiva[devolutiva] || 0) + 1;
                        }
                    }
                });

                // Processar segundo professor
                const inclusao = row['4a1 INCLUS√ÉO (o segundo professor integra o(s) estudante(s) especiais com a turma)'];
                const lideranca = row['4a2 LIDERAN√áA E PARTICIPA√á√ÉO ( o segundo professor √© participativo nas a√ß√µes e decis√µes tomadas pela turma)'];
                const freqSegundo = row['4a3 FREQU√äNCIA (o segundo professor est√° sempre acompanhando o(s) seu(s) estudante(s) e raramente falta)'];
                
                if (inclusao) {
                    processedData.segundoProfessor.inclusao[inclusao] = (processedData.segundoProfessor.inclusao[inclusao] || 0) + 1;
                }
                if (lideranca) {
                    processedData.segundoProfessor.lideranca[lideranca] = (processedData.segundoProfessor.lideranca[lideranca] || 0) + 1;
                }
                if (freqSegundo) {
                    processedData.segundoProfessor.frequencia[freqSegundo] = (processedData.segundoProfessor.frequencia[freqSegundo] || 0) + 1;
                }

                // Processar coment√°rios
                const sentimentos = row['2a Sinta-se √† vontade para escrever como voc√™ se sente na sua turma e nessa escola.'];
                const situacoes = row['5a1 Sinta-se √† vontade para escrever como voc√™ se sente nas aulas ou conte alguma situa√ß√£o pontual com professor(es).'];
                
                if (sentimentos && sentimentos.trim()) {
                    processedData.comentarios.sentimentos.push(sentimentos.trim());
                }
                if (situacoes && situacoes.trim()) {
                    processedData.comentarios.situacoesProfessores.push(situacoes.trim());
                }
            });
        }

        function generateDashboard() {
            generateStatsCards();
            generateCharts();
            generateInsights();
            generateComentarios();
            generateTable();
            generateReport();
            setupReportButton();
            setupTurmaSelector();
        }

        function generateStatsCards() {
            const statsGrid = document.getElementById('statsGrid');
            const totalRespostasValidas = processedData.totalRespostas > 0 ? processedData.totalRespostas : 1;

            const respeitoColegasPositivo = Object.entries(processedData.respeitoColegas)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            const respeitoProfessoresPositivo = Object.entries(processedData.respeitoProfessores)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);

            const avaliacoesPositivasEscola = Object.entries(processedData.avaliacaoEscola)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);

            const avaliacoesPositivasTurma = Object.entries(processedData.avaliacaoTurma)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);

            const disciplinasAvaliadas = Object.keys(processedData.disciplinas).length;

            const inclusaoOtima = Object.entries(processedData.segundoProfessor.inclusao)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            // Fun√ß√£o para gerar detalhes do hover
            function generateHoverDetails(data, title) {
                const total = Object.values(data).reduce((sum, value) => sum + value, 0);
                
                let details = `<div class="tooltip-title">${title}</div>`;
                
                // Ordenar por quantidade (maior para menor) e limitar a 4 itens principais
                const sortedEntries = Object.entries(data)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 4);
                
                sortedEntries.forEach(([key, value]) => {
                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    // Encurtar texto muito longo
                    const shortKey = key.length > 25 ? key.substring(0, 25) + '...' : key;
                    details += `
                        <div class="tooltip-item">
                            <span class="tooltip-label">${shortKey}</span>
                            <span class="tooltip-value">${percentage}%</span>
                        </div>
                    `;
                });
                
                details += `<div class="tooltip-total">üìä ${total} respostas</div>`;
                return details;
            }

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${processedData.totalRespostas}</div>
                    <div class="stat-label">Total de Respostas</div>
                </div>
                <div class="stat-card hover-card" data-hover="${generateHoverDetails(processedData.respeitoColegas, 'Respeito entre Colegas').replace(/"/g, '&quot;')}">
                    <div class="stat-number">${Math.round((respeitoColegasPositivo / totalRespostasValidas) * 100)}%</div>
                    <div class="stat-label">Respeito Positivo entre Colegas</div>
                    <div class="hover-icon">‚ÑπÔ∏è</div>
                </div>
                <div class="stat-card hover-card" data-hover="${generateHoverDetails(processedData.respeitoProfessores, 'Respeito aos Professores').replace(/"/g, '&quot;')}">
                    <div class="stat-number">${Math.round((respeitoProfessoresPositivo / totalRespostasValidas) * 100)}%</div>
                    <div class="stat-label">Respeito Positivo aos Professores</div>
                    <div class="hover-icon">‚ÑπÔ∏è</div>
                </div>
                <div class="stat-card hover-card" data-hover="${generateHoverDetails(processedData.avaliacaoTurma, 'Avalia√ß√£o da Turma').replace(/"/g, '&quot;')}">
                    <div class="stat-number">${Math.round((avaliacoesPositivasTurma / totalRespostasValidas) * 100)}%</div>
                    <div class="stat-label">Avalia√ß√£o Positiva da Turma</div>
                    <div class="hover-icon">‚ÑπÔ∏è</div>
                </div>
                <div class="stat-card hover-card" data-hover="${generateHoverDetails(processedData.avaliacaoEscola, 'Avalia√ß√£o da Escola').replace(/"/g, '&quot;')}">
                    <div class="stat-number">${Math.round((avaliacoesPositivasEscola / totalRespostasValidas) * 100)}%</div>
                    <div class="stat-label">Avalia√ß√£o Positiva da Escola</div>
                    <div class="hover-icon">‚ÑπÔ∏è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${disciplinasAvaliadas}</div>
                    <div class="stat-label">Disciplinas Avaliadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}%</div>
                    <div class="stat-label">Excelente Inclus√£o</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${processedData.comentarios.sentimentos.length + processedData.comentarios.situacoesProfessores.length}</div>
                    <div class="stat-label">Coment√°rios Analisados</div>
                </div>
            `;

            // Adicionar eventos de hover
            setupHoverCards();
        }

        function generateCharts() {
            const chartsGrid = document.getElementById('chartsGrid');
            chartsGrid.innerHTML = '';

            // Gr√°fico de Frequ√™ncia nas Aulas
            createChart('frequenciaChart', 'Frequ√™ncia nas Aulas', processedData.frequenciaAulas, 'doughnut');
            
            // Gr√°fico de Participa√ß√£o nas Aulas
            createChart('participacaoChart', 'Participa√ß√£o nas Aulas', processedData.participacaoAulas, 'bar');
            
            // Gr√°fico de Respeito aos Colegas
            createChart('respeitoColegasChart', 'Respeito aos Colegas', processedData.respeitoColegas, 'pie');
            
            // Gr√°fico de Avalia√ß√£o da Escola
            createChart('avaliacaoEscolaChart', 'Avalia√ß√£o da Escola', processedData.avaliacaoEscola, 'bar');
            
            // Gr√°ficos do Segundo Professor
            if (Object.keys(processedData.segundoProfessor.inclusao).length > 0) {
                createChart('inclusaoChart', 'Inclus√£o - Segundo Professor', processedData.segundoProfessor.inclusao, 'doughnut');
            }
            if (Object.keys(processedData.segundoProfessor.lideranca).length > 0) {
                createChart('liderancaChart', 'Lideran√ßa - Segundo Professor', processedData.segundoProfessor.lideranca, 'pie');
            }

            // Configurar seletor de disciplinas
            setupDisciplinaSelector();
        }

        function createChart(id, title, data, type) {
            const chartsGrid = document.getElementById('chartsGrid');
            
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3 class="chart-title">${title}</h3>
                <div style="position: relative; height: 400px; width: 100%;">
                    <canvas id="${id}"></canvas>
                </div>
            `;
            chartsGrid.appendChild(chartContainer);

            const ctx = document.getElementById(id).getContext('2d');
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            const total = values.reduce((sum, value) => sum + value, 0);
            
            const colors = [
                '#1C355E', '#FFA500', '#2F5F9E', '#FFD580',
                '#CC7000', '#8DA9C4', '#1C355E', '#FFA500',
                '#2F5F9E', '#FFD580', '#CC7000', '#8DA9C4'
            ];

            // Determinar se deve ocultar labels do eixo X
            const hideXLabels = title.includes('Participa√ß√£o nas Aulas') || title.includes('Avalia√ß√£o da Escola');

            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                },
                                // Ocultar legenda para gr√°ficos espec√≠ficos
                                filter: function(legendItem, chartData) {
                                    if (hideXLabels) {
                                        return false;
                                    }
                                    return true;
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#1C355E',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    // Obter valor correto dependendo do tipo de gr√°fico
                                    const value = type === 'bar' ? context.parsed.y : (context.parsed || context.raw);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    
                                    // Encurtar texto longo nos tooltips
                                    let label = context.label;
                                    if (label && label.length > 40) {
                                        label = label.substring(0, 40) + '...';
                                    }
                                    return `${label}: ${value} respostas (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    return `Total: ${total} respostas`;
                                }
                            }
                        }
                    },
                    scales: type === 'bar' ? {
                        x: {
                            display: !hideXLabels,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    // Limitar tamanho do texto no eixo X
                                    return label.length > 20 ? label.substring(0, 20) + '...' : label;
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    } : {}
                }
            });
        }

        function setupDisciplinaSelector() {
            const select = document.getElementById('disciplinaSelect');
            const chartsContainer = document.getElementById('disciplinaCharts');
            
            // Limpar op√ß√µes existentes
            select.innerHTML = '<option value="">-- Escolha uma disciplina --</option>';
            
            // Adicionar op√ß√µes das disciplinas
            Object.keys(processedData.disciplinas).forEach(disc => {
                const disciplina = processedData.disciplinas[disc];
                const option = document.createElement('option');
                option.value = disc;
                option.textContent = disciplina.nome;
                select.appendChild(option);
            });
            
            // Adicionar evento de mudan√ßa
            select.addEventListener('change', function() {
                currentFilter.disciplina = this.value;
                updateFilterInfo();
                
                if (this.value) {
                    showDisciplinaCharts(this.value);
                    chartsContainer.style.display = 'block';
                } else {
                    chartsContainer.style.display = 'none';
                }
            });
        }

        function setupTurmaSelector() {
            const select = document.getElementById('turmaSelect');
            
            // Limpar op√ß√µes existentes
            select.innerHTML = '<option value="">-- Todas as Turmas --</option>';
            
            // Coletar todas as turmas dos dados originais - buscar em diferentes poss√≠veis nomes de coluna
            const turmasDisponiveis = {};
            csvData.forEach(row => {
                const turmaAluno = row['Turma'] || row['TURMA'] || row['turma'] || 
                                 row['6 Turma'] || row['6 TURMA'] || row['6 turma'] ||
                                 row['Qual a sua turma?'] || row['QUAL A SUA TURMA?'] || '';
                if (turmaAluno && turmaAluno.trim()) {
                    const turmaNormalizada = turmaAluno.trim();
                    turmasDisponiveis[turmaNormalizada] = (turmasDisponiveis[turmaNormalizada] || 0) + 1;
                }
            });
            
            console.log('üìö Turmas encontradas:', turmasDisponiveis);
            
            // Adicionar op√ß√µes das turmas (ordenadas)
            Object.keys(turmasDisponiveis)
                .sort()
                .forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma;
                    option.textContent = `${turma} (${turmasDisponiveis[turma]} estudantes)`;
                    select.appendChild(option);
                });
            
            // Adicionar evento de mudan√ßa
            select.addEventListener('change', function() {
                currentFilter.turma = this.value;
                console.log('üéØ Filtro de turma alterado para:', this.value || 'Todas as turmas');
                
                // Reprocessar dados com o filtro
                processData(this.value);
                
                // Regenerar COMPLETAMENTE o dashboard com os dados filtrados
                generateStatsCards();
                generateCharts();
                generateInsights();
                generateComentarios();
                generateTable();
                generateReport();
                
                // Reconfigurar seletor de disciplinas com dados filtrados
                setupDisciplinaSelector();
                
                // Atualizar informa√ß√µes do filtro
                updateFilterInfo();
                
                console.log('‚úÖ Dashboard regenerado com filtro de turma aplicado');
            });
        }

        function updateFilterInfo() {
            const filtroInfo = document.getElementById('filtroInfo');
            const filtroTexto = document.getElementById('filtroTexto');
            
            let textoFiltro = '';
            const filtros = [];
            
            if (currentFilter.turma) {
                filtros.push(`Turma: ${currentFilter.turma}`);
            }
            
            if (currentFilter.disciplina) {
                const disciplinaNome = processedData.disciplinas[currentFilter.disciplina]?.nome || currentFilter.disciplina;
                filtros.push(`Disciplina: ${disciplinaNome}`);
            }
            
            if (filtros.length > 0) {
                textoFiltro = `üìä Visualizando dados filtrados por: ${filtros.join(' | ')}`;
                filtroInfo.style.display = 'block';
            } else {
                textoFiltro = 'üìä Visualizando todos os dados';
                filtroInfo.style.display = 'none';
            }
            
            filtroTexto.textContent = textoFiltro;
        }

        function showDisciplinaCharts(discKey) {
            const disciplina = processedData.disciplinas[discKey];
            const chartsGrid = document.getElementById('disciplinaChartsGrid');
            
            // Limpar gr√°ficos anteriores
            chartsGrid.innerHTML = '';
            
            // Criar gr√°ficos para a disciplina selecionada
            if (Object.keys(disciplina.afinidade).length > 0) {
                createDisciplinaChart(`afinidade${discKey}Chart`, `${disciplina.nome} - Afinidade dos Estudantes`, disciplina.afinidade, 'bar');
            }
            
            if (Object.keys(disciplina.didatica).length > 0) {
                createDisciplinaChart(`didatica${discKey}Chart`, `${disciplina.nome} - Did√°tica do Professor`, disciplina.didatica, 'doughnut');
            }
            
            if (Object.keys(disciplina.frequencia).length > 0) {
                createDisciplinaChart(`frequencia${discKey}Chart`, `${disciplina.nome} - Frequ√™ncia do Professor`, disciplina.frequencia, 'pie');
            }
            
            if (Object.keys(disciplina.devolutiva).length > 0) {
                createDisciplinaChart(`devolutiva${discKey}Chart`, `${disciplina.nome} - Devolutiva das Avalia√ß√µes`, disciplina.devolutiva, 'bar');
            }
            
            // Adicionar insights espec√≠ficos da disciplina
            addDisciplinaInsights(disciplina);
        }

        function createDisciplinaChart(id, title, data, type) {
            const chartsGrid = document.getElementById('disciplinaChartsGrid');
            
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <h3 class="chart-title">${title}</h3>
                <div style="position: relative; height: 400px; width: 100%;">
                    <canvas id="${id}"></canvas>
                </div>
            `;
            chartsGrid.appendChild(chartContainer);

            const ctx = document.getElementById(id).getContext('2d');
            
            const labels = Object.keys(data);
            const values = Object.values(data);
            const total = values.reduce((sum, value) => sum + value, 0);
            
            const colors = [
                '#1C355E', '#FFA500', '#2F5F9E', '#FFD580',
                '#CC7000', '#8DA9C4', '#1C355E', '#FFA500',
                '#2F5F9E', '#FFD580', '#CC7000', '#8DA9C4'
            ];

            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#1C355E',
                            borderWidth: 2,
                            cornerRadius: 10,
                            displayColors: true,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            callbacks: {
                                title: function(context) {
                                    // Encurtar t√≠tulo se muito longo
                                    let title = context[0].label || 'Sem r√≥tulo';
                                    if (title.length > 30) {
                                        title = title.substring(0, 30) + '...';
                                    }
                                    return title;
                                },
                                label: function(context) {
                                    // Obter valor correto dependendo do tipo de gr√°fico
                                    const value = type === 'bar' ? context.parsed.y : (context.parsed || context.raw);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    
                                    return `üìä ${value} respostas (${percentage}%)`;
                                },
                                afterLabel: function(context) {
                                    return `üìà Total geral: ${total} respostas`;
                                }
                            }
                        }
                    },
                    scales: type === 'bar' ? {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                callback: function(value, index, values) {
                                    const label = this.getLabelForValue(value);
                                    // Limitar tamanho do texto no eixo X
                                    return label.length > 20 ? label.substring(0, 20) + '...' : label;
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    } : {}
                }
            });
        }

        function addDisciplinaInsights(disciplina) {
            const chartsGrid = document.getElementById('disciplinaChartsGrid');
            
            // Calcular estat√≠sticas da disciplina
            const totalAfinidade = Object.values(disciplina.afinidade).reduce((sum, value) => sum + value, 0) || 1;
            const afinidadePositiva = Object.entries(disciplina.afinidade)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM') || key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            const totalDidatica = Object.values(disciplina.didatica).reduce((sum, value) => sum + value, 0) || 1;
            const didaticaPositiva = Object.entries(disciplina.didatica)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM') || key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            const totalFrequencia = Object.values(disciplina.frequencia).reduce((sum, value) => sum + value, 0) || 1;
            const frequenciaPositiva = Object.entries(disciplina.frequencia)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM') || key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            // Fun√ß√£o para gerar detalhes do hover para disciplinas
            function generateDisciplinaHoverDetails(data, title) {
                const total = Object.values(data).reduce((sum, value) => sum + value, 0);
                
                let details = `<div class="tooltip-title">${title}</div>`;
                
                // Ordenar por quantidade (maior para menor)
                const sortedEntries = Object.entries(data)
                    .sort(([,a], [,b]) => b - a);
                
                sortedEntries.forEach(([key, value]) => {
                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    // Encurtar texto muito longo
                    const shortKey = key.length > 25 ? key.substring(0, 25) + '...' : key;
                    details += `
                        <div class="tooltip-item">
                            <span class="tooltip-label">${shortKey}</span>
                            <span class="tooltip-value">${value} (${percentage}%)</span>
                        </div>
                    `;
                });
                
                details += `<div class="tooltip-total">üìä ${total} respostas</div>`;
                return details;
            }
            
            const insightsContainer = document.createElement('div');
            insightsContainer.className = 'chart-container';
            insightsContainer.innerHTML = `
                <h3 class="chart-title">üìä An√°lise Detalhada - ${disciplina.nome}</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="hover-card stat-card" data-hover="${generateDisciplinaHoverDetails(disciplina.afinidade, `${disciplina.nome} - Afinidade dos Estudantes`).replace(/"/g, '&quot;')}">
                        <div class="stat-number" style="color: #1C355E;">${Math.round((afinidadePositiva / totalAfinidade) * 100)}%</div>
                        <div class="stat-label">Afinidade Positiva</div>
                        <div class="hover-icon">‚ÑπÔ∏è</div>
                    </div>
                    <div class="hover-card stat-card" data-hover="${generateDisciplinaHoverDetails(disciplina.didatica, `${disciplina.nome} - Did√°tica do Professor`).replace(/"/g, '&quot;')}">
                        <div class="stat-number" style="color: #2F5F9E;">${Math.round((didaticaPositiva / totalDidatica) * 100)}%</div>
                        <div class="stat-label">Did√°tica Aprovada</div>
                        <div class="hover-icon">‚ÑπÔ∏è</div>
                    </div>
                    <div class="hover-card stat-card" data-hover="${generateDisciplinaHoverDetails(disciplina.frequencia, `${disciplina.nome} - Frequ√™ncia do Professor`).replace(/"/g, '&quot;')}">
                        <div class="stat-number" style="color: #6A5ACD;">${Math.round((frequenciaPositiva / totalFrequencia) * 100)}%</div>
                        <div class="stat-label">Frequ√™ncia Adequada</div>
                        <div class="hover-icon">‚ÑπÔ∏è</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%); border-radius: 8px; border-left: 4px solid #1e3c72;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px;">üí° Insights da Disciplina</h4>
                    <p style="margin: 0; color: #333;">
                        ${disciplina.nome} apresenta ${Math.round((afinidadePositiva / totalAfinidade) * 100)}% de afinidade positiva dos estudantes (${afinidadePositiva}/${totalAfinidade} respostas). 
                        A did√°tica do professor √© aprovada por ${Math.round((didaticaPositiva / totalDidatica) * 100)}% dos alunos (${didaticaPositiva}/${totalDidatica} respostas), 
                        e ${Math.round((frequenciaPositiva / totalFrequencia) * 100)}% consideram a frequ√™ncia adequada (${frequenciaPositiva}/${totalFrequencia} respostas).
                    </p>
                </div>
            `;
            chartsGrid.appendChild(insightsContainer);
            
            // Reconfigurar eventos de hover para os novos cart√µes
            setupHoverCards();
        }

        function generateComentarios() {
            const container = document.getElementById('comentariosContainer');
            container.innerHTML = '';

            const allComments = [
                ...processedData.comentarios.sentimentos,
                ...processedData.comentarios.situacoesProfessores
            ];

            if (allComments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum coment√°rio dispon√≠vel para o filtro selecionado.</p>';
                return;
            }

            // --- Fun√ß√£o de An√°lise Qualitativa ---
            function analyzeComments(comments) {
                const analysis = {
                    positive: [],
                    negative: [],
                    suggestion: [],
                    neutral: [],
                    themes: {}
                };

                const keywords = {
                    positive: ['gosto', 'adoro', 'bom', '√≥timo', 'excelente', 'parab√©ns', 'acolhedor', 'legal', 'amo', 'elogiar', 'gostei'],
                    negative: ['ruim', 'odeio', 'chato', 'dif√≠cil', 'problema', 'conversa', 'barulho', 'reclama', 'n√£o gosto', 'melhorar', 'falta'],
                    suggestion: ['poderia', 'sugiro', 'devia', 'precisa']
                };

                const themeKeywords = {
                    'Professores': ['professor', 'professora', 'prof', 'docente', 'ensina', 'explica'],
                    'Colegas e Turma': ['colega', 'amigo', 'turma', 'pessoal', 'gente', 'bagun√ßa', 'conversa'],
                    'Aulas e Conte√∫do': ['aula', 'mat√©ria', 'disciplina', 'conte√∫do', 'atividade', 'prova'],
                    'Escola e Estrutura': ['escola', 'dire√ß√£o', 'estrutura', 'regras', 'ambiente']
                };

                comments.forEach(comment => {
                    const lowerComment = comment.toLowerCase();
                    let isCategorized = false;

                    if (keywords.suggestion.some(kw => lowerComment.includes(kw))) {
                        analysis.suggestion.push(comment);
                        isCategorized = true;
                    } else if (keywords.positive.some(kw => lowerComment.includes(kw))) {
                        analysis.positive.push(comment);
                        isCategorized = true;
                    } else if (keywords.negative.some(kw => lowerComment.includes(kw))) {
                        analysis.negative.push(comment);
                        isCategorized = true;
                    }

                    if (!isCategorized) {
                        analysis.neutral.push(comment);
                    }

                    Object.keys(themeKeywords).forEach(theme => {
                        if (themeKeywords[theme].some(kw => lowerComment.includes(kw))) {
                            analysis.themes[theme] = (analysis.themes[theme] || 0) + 1;
                        }
                    });
                });
                return analysis;
            }
            // --- Fim da Fun√ß√£o de An√°lise ---

            const analysisResult = analyzeComments(allComments);

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; text-align: center;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724;">Positivos</h4>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #155724;">${analysisResult.positive.length}</p>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h4 style="color: #721c24;">Negativos</h4>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #721c24;">${analysisResult.negative.length}</p>
                    </div>
                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <h4 style="color: #0c5460;">Sugest√µes</h4>
                        <p style="font-size: 1.5rem; font-weight: bold; color: #0c5460;">${analysisResult.suggestion.length}</p>
                    </div>
                </div>
            `;
            
            const sortedThemes = Object.entries(analysisResult.themes).sort(([, a], [, b]) => b - a);

            if (sortedThemes.length > 0) {
                html += `
                    <div class="insight-item">
                        <h4>Principais Temas Mencionados</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${sortedThemes.map(([theme, count]) => `<span style="background: #1C355E; color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">${theme} (${count})</span>`).join('')}
                        </div>
                    </div>`;
            }

            function createCommentSection(title, comments, color) {
                if (comments.length === 0) return '';
                let sectionHtml = `
                    <div class="insight-item" style="border-left-color: ${color};">
                        <h4 style="color: ${color};">${title} (Amostra de ${Math.min(3, comments.length)})</h4>
                        <div style="max-height: 200px; overflow-y: auto; padding-right: 10px;">`;
                
                comments.slice(0, 3).forEach(comment => {
                    sectionHtml += `<p style="margin-bottom: 10px; padding: 10px; background: #f0f4f8; border-radius: 5px; border-left: 3px solid ${color};"><em>"${comment}"</em></p>`;
                });

                if (comments.length > 3) {
                    sectionHtml += `<p style="text-align: center; color: #666; margin-top: 10px;">... e mais ${comments.length - 3} coment√°rios</p>`;
                }
                sectionHtml += '</div></div>';
                return sectionHtml;
            }

            html += createCommentSection('üëç Coment√°rios Positivos', analysisResult.positive, '#28a745');
            html += createCommentSection('üëé Coment√°rios de Pontos de Melhoria', analysisResult.negative, '#dc3545');
            html += createCommentSection('üí° Sugest√µes dos Estudantes', analysisResult.suggestion, '#17a2b8');
            
            container.innerHTML = html;
        }

        function generateInsights() {
            const container = document.getElementById('insightsContainer');
            const filtroAtivo = processedData.filtroAtivo;
            const totalRespostasValidas = processedData.totalRespostas > 0 ? processedData.totalRespostas : 1;

            // Calcular insights
            const frequenciaProblemas = Object.entries(processedData.frequenciaAulas)
                .filter(([key]) => key.toLowerCase().includes('falto'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            const participacaoExcelente = Object.entries(processedData.participacaoAulas)
                .filter(([key]) => key.toLowerCase().includes('√≥timo') || key.toLowerCase().includes('excelente'))
                .reduce((sum, [, value]) => sum + value, 0);

            const turmaRegular = Object.entries(processedData.avaliacaoTurma)
                .filter(([key]) => key.toLowerCase().includes('regular'))
                .reduce((sum, [, value]) => sum + value, 0);

            const inclusaoOtima = Object.entries(processedData.segundoProfessor.inclusao)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            // Calcular disciplina com melhor avalia√ß√£o
            let melhorDisciplina = 'N/A';
            let melhorPercentual = 0;
            Object.keys(processedData.disciplinas).forEach(disc => {
                const disciplina = processedData.disciplinas[disc];
                const total = Object.values(disciplina.afinidade).reduce((sum, value) => sum + value, 0);
                if (total > 0) {
                    const positivas = Object.entries(disciplina.afinidade)
                        .filter(([key]) => key.toUpperCase().includes('√ìTIM') || key.toUpperCase().includes('BOM'))
                        .reduce((sum, [, value]) => sum + value, 0);
                    const percentual = (positivas / total) * 100;
                    
                    if (percentual > melhorPercentual) {
                        melhorPercentual = percentual;
                        melhorDisciplina = disciplina.nome;
                    }
                }
            });

            let headerText = filtroAtivo 
                ? `<h3 style="color: #1C355E; margin-bottom: 20px; text-align:center; font-size: 1.3rem;">Insights para a Turma: ${filtroAtivo}</h3>` 
                : '';

            container.innerHTML = headerText + `
                <div class="insight-item">
                    <h4>üéØ Frequ√™ncia Escolar</h4>
                    <p>${Math.round((frequenciaProblemas / totalRespostasValidas) * 100)}% dos estudantes relatam faltar √†s aulas. Recomenda-se investigar os motivos e criar estrat√©gias de engajamento.</p>
                </div>
                <div class="insight-item">
                    <h4>üìö Participa√ß√£o nas Aulas</h4>
                    <p>${Math.round((participacaoExcelente / totalRespostasValidas) * 100)}% dos estudantes demonstram excelente participa√ß√£o, um ponto forte a ser mantido.</p>
                </div>
                <div class="insight-item">
                    <h4>üë• Ambiente da Turma</h4>
                    <p>${Math.round((turmaRegular / totalRespostasValidas) * 100)}% avaliam a turma como "regular", frequentemente citando conversas paralelas como um desafio.</p>
                </div>
                <div class="insight-item">
                    <h4>ü§ù Trabalho de Inclus√£o</h4>
                    <p>${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}% avaliam como "√≥tima" a inclus√£o realizada pelo segundo professor, um indicador de excel√™ncia no apoio especializado.</p>
                </div>
                <div class="insight-item">
                    <h4>üèÜ Disciplina Destaque</h4>
                    <p>No filtro atual, <strong>${melhorDisciplina}</strong> se destaca com aproximadamente <strong>${Math.round(melhorPercentual)}%</strong> de avalia√ß√£o positiva, sendo um referencial de boas pr√°ticas.</p>
                </div>
            `;
        }

        function generateTable() {
            const container = document.getElementById('tableContainer');
            
            let tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Aspecto Avaliado</th>
                            <th>Respostas Positivas (√ìtimo/Bom)</th>
                            <th>Respostas Neutras (Regular)</th>
                            <th>Pontos de Melhoria</th>
                            <th>% Satisfa√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const aspects = [
                { name: 'Respeito aos Colegas', data: processedData.respeitoColegas },
                { name: 'Respeito aos Professores', data: processedData.respeitoProfessores },
                { name: 'Avalia√ß√£o da Turma', data: processedData.avaliacaoTurma },
                { name: 'Avalia√ß√£o da Escola', data: processedData.avaliacaoEscola },
                { name: 'Inclus√£o - 2¬∫ Professor', data: processedData.segundoProfessor.inclusao },
                { name: 'Lideran√ßa - 2¬∫ Professor', data: processedData.segundoProfessor.lideranca }
            ];

            aspects.forEach(aspect => {
                const positive = Object.entries(aspect.data)
                    .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                    .reduce((sum, [, value]) => sum + value, 0);
                
                const neutral = Object.entries(aspect.data)
                    .filter(([key]) => key.toUpperCase().includes('REGULAR'))
                    .reduce((sum, [, value]) => sum + value, 0);
                
                const total = Object.values(aspect.data).reduce((s, v) => s + v, 0);
                const negative = total - positive - neutral;

                const satisfaction = total > 0 ? Math.round((positive / total) * 100) : 0;

                tableHTML += `
                    <tr>
                        <td>${aspect.name}</td>
                        <td>${positive}</td>
                        <td>${neutral}</td>
                        <td>${negative}</td>
                        <td>${satisfaction}%</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function generateReport() {
            const container = document.getElementById('reportContent');
            
            const today = new Date().toLocaleDateString('pt-BR');
            const totalRespostasValidas = processedData.totalRespostas > 0 ? processedData.totalRespostas : 1;
            
            const respeitoColegasPositivo = Object.entries(processedData.respeitoColegas)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            const respeitoProfessoresPositivo = Object.entries(processedData.respeitoProfessores)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);

            const avaliacoesPositivasEscola = Object.entries(processedData.avaliacaoEscola)
                .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                .reduce((sum, [, value]) => sum + value, 0);

            const inclusaoOtima = Object.entries(processedData.segundoProfessor.inclusao)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 style="color: #1C355E; font-size: 1.8rem; margin-bottom: 10px;">üìã Relat√≥rio Executivo</h3>
                    <p style="color: #666; font-size: 1rem; margin: 0;">${today}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #1C355E;">
                    <h4 style="color: #1C355E; margin-bottom: 15px; font-size: 1.3rem;">üìä Resumo Executivo</h4>
                    <p style="line-height: 1.8; font-size: 1.05rem; margin: 0; text-align: justify;">
                        Esta pesquisa coletou <strong style="color: #1C355E;">${processedData.totalRespostas} respostas</strong>, 
                        avaliando diversos aspectos do ambiente escolar, desempenho acad√™mico e trabalho de inclus√£o. Os dados revelam um panorama 
                        abrangente das percep√ß√µes estudantis sobre <strong style="color: #1C355E;">${Object.keys(processedData.disciplinas).length} disciplinas</strong> 
                        e <strong style="color: #1C355E;">${processedData.comentarios.sentimentos.length + processedData.comentarios.situacoesProfessores.length} coment√°rios qualitativos</strong>.
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #28a745;">
                        <div style="font-size: 2.2rem; font-weight: bold; color: #28a745; margin-bottom: 8px;">
                            ${Math.round((respeitoColegasPositivo / totalRespostasValidas) * 100)}%
                        </div>
                        <div style="font-size: 0.95rem; color: #666; font-weight: 600;">Respeito entre Colegas</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #28a745;">
                        <div style="font-size: 2.2rem; font-weight: bold; color: #28a745; margin-bottom: 8px;">
                            ${Math.round((respeitoProfessoresPositivo / totalRespostasValidas) * 100)}%
                        </div>
                        <div style="font-size: 0.95rem; color: #666; font-weight: 600;">Respeito aos Professores</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #28a745;">
                        <div style="font-size: 2.2rem; font-weight: bold; color: #28a745; margin-bottom: 8px;">
                            ${Math.round((avaliacoesPositivasEscola / totalRespostasValidas) * 100)}%
                        </div>
                        <div style="font-size: 0.95rem; color: #666; font-weight: 600;">Satisfa√ß√£o com a Escola</div>
                    </div>
                    <div style="background: #d1ecf1; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #17a2b8;">
                        <div style="font-size: 2.2rem; font-weight: bold; color: #0c5460; margin-bottom: 8px;">
                            ${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}%
                        </div>
                        <div style="font-size: 0.95rem; color: #666; font-weight: 600;">Excelente Inclus√£o</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); border-left: 5px solid #2F5F9E;">
                    <h4 style="color: #2F5F9E; margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                        üéØ Principais Descobertas
                    </h4>
                    <div style="display: grid; gap: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 3px solid #28a745;">
                            <strong style="color: #28a745;">‚úÖ Relacionamento Interpessoal:</strong>
                            <p style="margin: 8px 0 0 0; line-height: 1.6;">Alto n√≠vel de respeito entre colegas e professores, criando ambiente escolar saud√°vel.</p>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 3px solid #ffc107;">
                            <strong style="color: #856404;">‚ö†Ô∏è Frequ√™ncia e Concentra√ß√£o:</strong>
                            <p style="margin: 8px 0 0 0; line-height: 1.6;">Necessidade de aten√ß√£o para reduzir faltas e melhorar a concentra√ß√£o em sala, com relatos de conversas paralelas.</p>
                        </div>
                        <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 3px solid #17a2b8;">
                            <strong style="color: #0c5460;">ü§ù Trabalho de Inclus√£o:</strong>
                            <p style="margin: 8px 0 0 0; line-height: 1.6;">Excelente avalia√ß√£o do segundo professor no apoio especializado, demonstrando efetividade e integra√ß√£o.</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); border-left: 5px solid #6A5ACD;">
                    <h4 style="color: #6A5ACD; margin-bottom: 20px; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                        üí° Recomenda√ß√µes Estrat√©gicas
                    </h4>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="background: #6A5ACD; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0;">1</span>
                            <div>
                                <strong style="color: #6A5ACD;">Foco na Sala de Aula</strong>
                                <p style="margin: 4px 0 0 0; line-height: 1.5; color: #666;">Implementar din√¢micas e acordos de conviv√™ncia para melhorar a concentra√ß√£o e a frequ√™ncia.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <span style="background: #6A5ACD; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0;">2</span>
                            <div>
                                <strong style="color: #6A5ACD;">Reconhecer Boas Pr√°ticas</strong>
                                <p style="margin: 4px 0 0 0; line-height: 1.5; color: #666;">Valorizar e replicar as estrat√©gias de professores e disciplinas bem avaliadas.</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                           <span style="background: #6A5ACD; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0;">3</span>
                            <div>
                                <strong style="color: #6A5ACD;">Monitoramento Cont√≠nuo</strong>
                                <p style="margin: 4px 0 0 0; line-height: 1.5; color: #666;">Utilizar esta ferramenta para acompanhamento trimestral, ajustando as estrat√©gias conforme a evolu√ß√£o dos dados.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupReportButton() {
            const button = document.getElementById('generateReportBtn');
            button.addEventListener('click', function() {
                generateCompleteReport();
            });
        }

        function generateCompleteReport() {
            // Obter informa√ß√µes do cabe√ßalho
            const unidadeEscolar = document.getElementById('unidadeEscolar').textContent;
            const turmasAvaliadas = document.getElementById('turmasAvaliadas').textContent;
            const periodoAplicacao = document.getElementById('periodoAplicacao').textContent;
            
            // Calcular estat√≠sticas principais
            const totalRespostasValidas = processedData.totalRespostas;
            
            const bonsRespeitoColegas = Object.entries(processedData.respeitoColegas)
                .filter(([key]) => key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);
            
            const bonsRespeitoProfessores = Object.entries(processedData.respeitoProfessores)
                .filter(([key]) => key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);

            const avaliacoesPositivasEscola = Object.entries(processedData.avaliacaoEscola)
                .filter(([key]) => key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);

            const avaliacoesPositivasTurma = Object.entries(processedData.avaliacaoTurma)
                .filter(([key]) => key.toUpperCase().includes('BOM'))
                .reduce((sum, [, value]) => sum + value, 0);

            const inclusaoOtima = Object.entries(processedData.segundoProfessor.inclusao)
                .filter(([key]) => key.toUpperCase().includes('√ìTIM'))
                .reduce((sum, [, value]) => sum + value, 0);

            // Calcular disciplina com melhor avalia√ß√£o
            let melhorDisciplina = '';
            let melhorPercentual = 0;
            Object.keys(processedData.disciplinas).forEach(disc => {
                const disciplina = processedData.disciplinas[disc];
                const positivas = Object.entries(disciplina.afinidade)
                    .filter(([key]) => key.toUpperCase().includes('√ìTIM') || key.toUpperCase().includes('BOM'))
                    .reduce((sum, [, value]) => sum + value, 0);
                const total = Object.values(disciplina.afinidade).reduce((sum, value) => sum + value, 0);
                const percentual = total > 0 ? (positivas / total) * 100 : 0;
                
                if (percentual > melhorPercentual) {
                    melhorPercentual = percentual;
                    melhorDisciplina = disciplina.nome;
                }
            });

            // Gerar tabela de aspectos avaliados
            const aspects = [
                { name: 'Respeito aos Colegas', data: processedData.respeitoColegas },
                { name: 'Respeito aos Professores', data: processedData.respeitoProfessores },
                { name: 'Avalia√ß√£o da Turma', data: processedData.avaliacaoTurma },
                { name: 'Avalia√ß√£o da Escola', data: processedData.avaliacaoEscola },
                { name: 'Inclus√£o - 2¬∫ Professor', data: processedData.segundoProfessor.inclusao },
                { name: 'Lideran√ßa - 2¬∫ Professor', data: processedData.segundoProfessor.lideranca }
            ];

            let tableRows = '';
            aspects.forEach(aspect => {
                const positive = Object.entries(aspect.data)
                    .filter(([key]) => key.toUpperCase().includes('BOM') || key.toUpperCase().includes('√ìTIMO'))
                    .reduce((sum, [, value]) => sum + value, 0);
                
                const neutral = Object.entries(aspect.data)
                    .filter(([key]) => key.toUpperCase().includes('REGULAR'))
                    .reduce((sum, [, value]) => sum + value, 0);
                
                const negative = Object.entries(aspect.data)
                    .filter(([key]) => !key.toUpperCase().includes('BOM') && !key.toUpperCase().includes('√ìTIMO') && !key.toUpperCase().includes('REGULAR'))
                    .reduce((sum, [, value]) => sum + value, 0);

                const total = positive + neutral + negative;
                const satisfaction = total > 0 ? Math.round((positive / total) * 100) : 0;

                tableRows += `
                    <tr>
                        <td>${aspect.name}</td>
                        <td>${positive}</td>
                        <td>${neutral}</td>
                        <td>${negative}</td>
                        <td>${satisfaction}%</td>
                    </tr>
                `;
            });

            // Gerar lista de disciplinas avaliadas
            let disciplinasList = '';
            Object.keys(processedData.disciplinas).forEach(disc => {
                const disciplina = processedData.disciplinas[disc];
                const totalAfinidade = Object.values(disciplina.afinidade).reduce((sum, value) => sum + value, 0);
                const afinidadePositiva = Object.entries(disciplina.afinidade)
                    .filter(([key]) => key.toUpperCase().includes('√ìTIM') || key.toUpperCase().includes('BOM'))
                    .reduce((sum, [, value]) => sum + value, 0);
                const percentualAfinidade = totalAfinidade > 0 ? Math.round((afinidadePositiva / totalAfinidade) * 100) : 0;
                
                disciplinasList += `<li><strong>${disciplina.nome}:</strong> ${percentualAfinidade}% de afinidade positiva (${afinidadePositiva}/${totalAfinidade} respostas)</li>`;
            });

            // Gerar amostra de coment√°rios
            let comentariosSample = '';
            if (processedData.comentarios.sentimentos.length > 0) {
                comentariosSample += '<h4>üè´ Amostra de Coment√°rios sobre a Escola:</h4><ul>';
                processedData.comentarios.sentimentos.slice(0, 5).forEach((comentario, index) => {
                    comentariosSample += `<li><em>"${comentario}"</em></li>`;
                });
                if (processedData.comentarios.sentimentos.length > 5) {
                    comentariosSample += `<li><em>... e mais ${processedData.comentarios.sentimentos.length - 5} coment√°rios</em></li>`;
                }
                comentariosSample += '</ul>';
            }

            if (processedData.comentarios.situacoesProfessores.length > 0) {
                comentariosSample += '<h4>üë®‚Äçüè´ Amostra de Relatos sobre Professores:</h4><ul>';
                processedData.comentarios.situacoesProfessores.slice(0, 5).forEach((comentario, index) => {
                    comentariosSample += `<li><em>"${comentario}"</em></li>`;
                });
                if (processedData.comentarios.situacoesProfessores.length > 5) {
                    comentariosSample += `<li><em>... e mais ${processedData.comentarios.situacoesProfessores.length - 5} coment√°rios</em></li>`;
                }
                comentariosSample += '</ul>';
            }

            const reportHTML = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Relat√≥rio Completo - Pesquisa Educacional</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            background: #f8f9fa;
                            padding: 20px;
                        }
                        
                        .container {
                            max-width: 1200px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 15px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                            overflow: hidden;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 50%, #8DA9C4 100%);
                            color: white;
                            padding: 40px;
                            text-align: center;
                        }
                        
                        .header-logo {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .logo-image {
                            max-width: 120px;
                            height: auto;
                            filter: brightness(0) invert(1);
                        }
                        
                        .header h1 {
                            font-size: 2.5rem;
                            margin-bottom: 10px;
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                        }
                        
                        .header .subtitle {
                            font-size: 1.3rem;
                            opacity: 0.9;
                            font-weight: 300;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 20px;
                            margin: 30px 0;
                            padding: 20px;
                            background: rgba(255,255,255,0.1);
                            border-radius: 10px;
                            backdrop-filter: blur(10px);
                        }
                        
                        .info-item {
                            text-align: left;
                        }
                        
                        .info-label {
                            font-weight: bold;
                            font-size: 0.9rem;
                            opacity: 0.8;
                            margin-bottom: 5px;
                        }
                        
                        .info-value {
                            font-size: 1.1rem;
                            font-weight: 600;
                        }
                        
                        .content {
                            padding: 40px;
                        }
                        
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 20px;
                            margin: 30px 0;
                        }
                        
                        .stat-card {
                            background: linear-gradient(135deg, #f8faff 0%, #e8f2ff 100%);
                            border: 2px solid #1C355E;
                            border-radius: 15px;
                            padding: 25px;
                            text-align: center;
                            transition: transform 0.3s ease;
                        }
                        
                        .stat-card:hover {
                            transform: translateY(-5px);
                        }
                        
                        .stat-number {
                            font-size: 2.5rem;
                            font-weight: bold;
                            color: #1C355E;
                            margin-bottom: 10px;
                            text-shadow: 0 2px 4px rgba(28, 53, 94, 0.2);
                        }
                        
                        .stat-label {
                            font-size: 1rem;
                            color: #666;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: bold;
                        }
                        
                        .section {
                            margin: 40px 0;
                            padding: 30px;
                            background: #f8f9fa;
                            border-radius: 15px;
                            border-left: 5px solid #1C355E;
                        }
                        
                        .section h2 {
                            color: #1C355E;
                            margin-bottom: 20px;
                            font-size: 1.8rem;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }
                        
                        .section h3 {
                            color: #2F5F9E;
                            margin: 25px 0 15px 0;
                            font-size: 1.4rem;
                        }
                        
                        .section h4 {
                            color: #1C355E;
                            margin: 20px 0 10px 0;
                            font-size: 1.2rem;
                        }
                        
                        .table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            background: white;
                            border-radius: 10px;
                            overflow: hidden;
                            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        }
                        
                        .table th,
                        .table td {
                            padding: 15px;
                            text-align: left;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .table th {
                            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 100%);
                            color: white;
                            font-weight: bold;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                        }
                        
                        .table tr:hover {
                            background: #f5f5f5;
                        }
                        
                        .insight-item {
                            background: white;
                            border-left: 4px solid #1C355E;
                            padding: 20px;
                            margin: 15px 0;
                            border-radius: 0 10px 10px 0;
                            box-shadow: 0 2px 8px rgba(28, 53, 94, 0.1);
                        }
                        
                        .insight-item h4 {
                            color: #1C355E;
                            margin-bottom: 10px;
                            font-weight: 600;
                        }
                        
                        ul {
                            padding-left: 25px;
                            margin: 15px 0;
                        }
                        
                        li {
                            margin-bottom: 8px;
                        }
                        
                        .footer {
                            background: linear-gradient(135deg, #1C355E 0%, #2F5F9E 100%);
                            color: white;
                            padding: 30px;
                            text-align: center;
                            margin-top: 40px;
                        }
                        
                        .footer p {
                            margin: 5px 0;
                        }
                        
                        .print-btn {
                            background: linear-gradient(45deg, #28a745, #20c997);
                            color: white;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 1.1rem;
                            margin: 20px auto;
                            display: block;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                            font-weight: bold;
                        }
                        
                        .print-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
                        }
                        
                        @media print {
                            body { 
                                background: white; 
                                padding: 0; 
                            }
                            .container { 
                                box-shadow: none; 
                                border-radius: 0; 
                            }
                            .print-btn { 
                                display: none; 
                            }
                        }
                        
                        @media (max-width: 768px) {
                            .header h1 {
                                font-size: 2rem;
                            }
                            .info-grid {
                                grid-template-columns: 1fr;
                            }
                            .stats-grid {
                                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            }
                            .content {
                                padding: 20px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="header-logo">
                                <img src="https://i.ibb.co/Ld7f2SqF/educavisor.png" alt="EDUCAVISOR Logo" class="logo-image">
                                <h1>EDUCAVISOR</h1>
                            </div>
                            <p class="subtitle">Relat√≥rio Anal√≠tico dos Resultados do Pr√©-Conselho Escolar</p>
                            
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">üè´ Unidade Escolar</div>
                                    <div class="info-value">${unidadeEscolar}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">üë• Turmas Avaliadas</div>
                                    <div class="info-value">${turmasAvaliadas}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">üìÖ Per√≠odo de Aplica√ß√£o</div>
                                    <div class="info-value">${periodoAplicacao}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">üë®‚Äçüíº Respons√°vel T√©cnico</div>
                                    <div class="info-value">Gestor Pedag√≥gico</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content">
                            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                            
                            <div class="section">
                                <h2>üìä Dados Gerais da Pesquisa</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number">${totalRespostasValidas}</div>
                                        <div class="stat-label">Total de Respostas</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${Math.round((bonsRespeitoColegas / totalRespostasValidas) * 100)}%</div>
                                        <div class="stat-label">Bom Respeito entre Colegas</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${Math.round((bonsRespeitoProfessores / totalRespostasValidas) * 100)}%</div>
                                        <div class="stat-label">Bom Respeito aos Professores</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${Math.round((avaliacoesPositivasTurma / totalRespostasValidas) * 100)}%</div>
                                        <div class="stat-label">Avalia√ß√£o Positiva da Turma</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${Math.round((avaliacoesPositivasEscola / totalRespostasValidas) * 100)}%</div>
                                        <div class="stat-label">Avalia√ß√£o Positiva da Escola</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${Object.keys(processedData.disciplinas).length}</div>
                                        <div class="stat-label">Disciplinas Avaliadas</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}%</div>
                                        <div class="stat-label">Excelente Inclus√£o</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number">${processedData.comentarios.sentimentos.length + processedData.comentarios.situacoesProfessores.length}</div>
                                        <div class="stat-label">Coment√°rios Coletados</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <h2>üìã Informa√ß√µes Detalhadas por Aspecto</h2>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Aspecto Avaliado</th>
                                            <th>Respostas Positivas</th>
                                            <th>Respostas Neutras</th>
                                            <th>Respostas Negativas</th>
                                            <th>% Satisfa√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="section">
                                <h2>üìö An√°lise das Disciplinas</h2>
                                <h3>üèÜ Disciplina Destaque</h3>
                                <div class="insight-item">
                                    <h4>${melhorDisciplina}</h4>
                                    <p>Apresenta ${Math.round(melhorPercentual)}% de satisfa√ß√£o dos estudantes, sendo a disciplina com melhor avalia√ß√£o de afinidade.</p>
                                </div>
                                
                                <h3>üìä Detalhamento por Disciplina</h3>
                                <ul>
                                    ${disciplinasList}
                                </ul>
                            </div>
                            
                            <div class="section">
                                <h2>üí° Principais Insights</h2>
                                <div class="insight-item">
                                    <h4>üéØ Frequ√™ncia Escolar</h4>
                                    <p>Identificada necessidade de aten√ß√£o para reduzir faltas injustificadas. Recomenda-se implementar estrat√©gias de engajamento estudantil.</p>
                                </div>
                                <div class="insight-item">
                                    <h4>üë• Ambiente da Turma</h4>
                                    <p>Turmas apresentam potencial de melhoria na concentra√ß√£o, com relatos de conversas paralelas. Sugest√£o: implementar din√¢micas de grupo.</p>
                                </div>
                                <div class="insight-item">
                                    <h4>üè´ Satisfa√ß√£o com a Escola</h4>
                                    <p>Estudantes demonstram boa adapta√ß√£o ao ambiente escolar, com avalia√ß√µes majoritariamente positivas sobre a institui√ß√£o.</p>
                                </div>
                                <div class="insight-item">
                                    <h4>ü§ù Trabalho de Inclus√£o</h4>
                                    <p>${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}% dos estudantes avaliam como √≥tima a inclus√£o realizada pelo segundo professor, demonstrando efetividade no apoio especializado.</p>
                                </div>
                                <div class="insight-item">
                                    <h4>üìö Relacionamento Interpessoal</h4>
                                    <p>Alto n√≠vel de respeito entre colegas (${Math.round((bonsRespeitoColegas / totalRespostasValidas) * 100)}%) e professores (${Math.round((bonsRespeitoProfessores / totalRespostasValidas) * 100)}%), indicando ambiente escolar saud√°vel.</p>
                                </div>
                            </div>
                            
                            <div class="section">
                                <h2>üí¨ Feedback Qualitativo dos Estudantes</h2>
                                ${comentariosSample}
                            </div>
                            
                            <div class="section">
                                <h2>üìà Recomenda√ß√µes e Pr√≥ximos Passos</h2>
                                <h3>üí° Recomenda√ß√µes Priorit√°rias</h3>
                                <ul>
                                    <li><strong>Frequ√™ncia Escolar:</strong> Implementar programas de incentivo √† frequ√™ncia e identificar causas das faltas</li>
                                    <li><strong>Concentra√ß√£o em Sala:</strong> Desenvolver estrat√©gias para reduzir conversas paralelas e melhorar o foco</li>
                                    <li><strong>Pr√°ticas Pedag√≥gicas:</strong> Manter e expandir as pr√°ticas que geram satisfa√ß√£o estudantil</li>
                                    <li><strong>Integra√ß√£o Social:</strong> Criar mais oportunidades de integra√ß√£o e colabora√ß√£o entre estudantes</li>
                                    <li><strong>Apoio Especializado:</strong> Continuar fortalecendo o trabalho de inclus√£o j√° bem avaliado</li>
                                </ul>
                                
                                <h3>üìÖ Cronograma Sugerido</h3>
                                <ul>
                                    <li><strong>Curto Prazo (30 dias):</strong> Implementar estrat√©gias para reduzir conversas paralelas</li>
                                    <li><strong>M√©dio Prazo (90 dias):</strong> Desenvolver programa de incentivo √† frequ√™ncia</li>
                                    <li><strong>Longo Prazo (180 dias):</strong> Avaliar impacto das medidas implementadas</li>
                                    <li><strong>Acompanhamento:</strong> Reaplicar pesquisa trimestralmente para monitoramento</li>
                                </ul>
                            </div>
                            
                            <div class="section">
                                <h2>üìä Relat√≥rio Executivo Consolidado</h2>
                                
                                <h3>üè´ Cabe√ßalho Institucional</h3>
                                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #1C355E; margin: 20px 0;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                        <div>
                                            <strong style="color: #1C355E;">üè´ Unidade Escolar:</strong><br>
                                            <span style="font-size: 1.1rem;">${unidadeEscolar}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #1C355E;">üë• Turmas Avaliadas:</strong><br>
                                            <span style="font-size: 1.1rem;">${turmasAvaliadas}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #1C355E;">üìÖ Per√≠odo de Aplica√ß√£o:</strong><br>
                                            <span style="font-size: 1.1rem;">${periodoAplicacao}</span>
                                        </div>
                                        <div>
                                            <strong style="color: #1C355E;">üë®‚Äçüíº Respons√°vel T√©cnico:</strong><br>
                                            <span style="font-size: 1.1rem;">Gestor Pedag√≥gico</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <h3>üìã S√≠ntese Executiva</h3>
                                <p style="text-align: justify; line-height: 1.8; font-size: 1.05rem;">
                                    Este relat√≥rio sintetiza as percep√ß√µes de <strong>${totalRespostasValidas} estudantes</strong> sobre o ambiente escolar, pr√°ticas pedag√≥gicas e inclus√£o, abrangendo <strong>${Object.keys(processedData.disciplinas).length} componentes curriculares</strong>. Os dados apontam para um ambiente respeitoso entre colegas (<strong>${Math.round((bonsRespeitoColegas / totalRespostasValidas) * 100)}%</strong>) e professores (<strong>${Math.round((bonsRespeitoProfessores / totalRespostasValidas) * 100)}%</strong>), mas tamb√©m revelam desafios como a frequ√™ncia escolar irregular e dispers√£o em sala de aula. A atua√ß√£o do segundo professor foi altamente valorizada (<strong>${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}% consideram √≥tima</strong>), evidenciando a import√¢ncia do apoio √† inclus√£o.
                                </p>
                                
                                <p style="text-align: justify; line-height: 1.8; font-size: 1.05rem;">
                                    Al√©m disso, <strong>${processedData.comentarios.sentimentos.length + processedData.comentarios.situacoesProfessores.length} coment√°rios qualitativos</strong> forneceram um panorama detalhado das percep√ß√µes dos alunos, enriquecendo os dados quantitativos e possibilitando recomenda√ß√µes pr√°ticas, como o fortalecimento de a√ß√µes para melhoria da concentra√ß√£o em sala, manuten√ß√£o de estrat√©gias bem avaliadas e promo√ß√£o da integra√ß√£o entre os estudantes.
                                </p>
                                
                                <h3>üéØ Principais Indicadores</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;">${Math.round((bonsRespeitoColegas / totalRespostasValidas) * 100)}%</div>
                                        <div style="font-size: 0.9rem; color: #666;">Respeito entre Colegas</div>
                                    </div>
                                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;">${Math.round((bonsRespeitoProfessores / totalRespostasValidas) * 100)}%</div>
                                        <div style="font-size: 0.9rem; color: #666;">Respeito aos Professores</div>
                                    </div>
                                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #ffc107;">
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #856404;">${Math.round((avaliacoesPositivasTurma / totalRespostasValidas) * 100)}%</div>
                                        <div style="font-size: 0.9rem; color: #666;">Avalia√ß√£o Positiva da Turma</div>
                                    </div>
                                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;">${Math.round((avaliacoesPositivasEscola / totalRespostasValidas) * 100)}%</div>
                                        <div style="font-size: 0.9rem; color: #666;">Satisfa√ß√£o com a Escola</div>
                                    </div>
                                    <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #17a2b8;">
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #0c5460;">${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}%</div>
                                        <div style="font-size: 0.9rem; color: #666;">Excelente Inclus√£o</div>
                                    </div>
                                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #dc3545;">
                                        <div style="font-size: 1.8rem; font-weight: bold; color: #721c24;">${Object.entries(processedData.frequenciaAulas).filter(([key]) => key.toLowerCase().includes('falto')).reduce((sum, [, value]) => sum + value, 0)}</div>
                                        <div style="font-size: 0.9rem; color: #666;">Estudantes com Faltas</div>
                                    </div>
                                </div>
                                
                                <h3>üí° Insights e Descobertas</h3>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #1C355E;">
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li style="margin-bottom: 10px;"><strong>Ambiente Respeitoso:</strong> ${Math.round((bonsRespeitoColegas / totalRespostasValidas) * 100)}% dos estudantes demonstram bom respeito entre colegas e ${Math.round((bonsRespeitoProfessores / totalRespostasValidas) * 100)}% com professores, indicando clima escolar saud√°vel.</li>
                                        <li style="margin-bottom: 10px;"><strong>Desafio da Frequ√™ncia:</strong> Identificados ${Object.entries(processedData.frequenciaAulas).filter(([key]) => key.toLowerCase().includes('falto')).reduce((sum, [, value]) => sum + value, 0)} estudantes com faltas recorrentes, demandando estrat√©gias de engajamento.</li>
                                        <li style="margin-bottom: 10px;"><strong>Concentra√ß√£o em Sala:</strong> Relatos de conversas paralelas indicam necessidade de din√¢micas mais envolventes.</li>
                                        <li style="margin-bottom: 10px;"><strong>Trabalho de Inclus√£o Exemplar:</strong> ${Math.round((inclusaoOtima / totalRespostasValidas) * 100)}% avaliam como √≥tima a atua√ß√£o do segundo professor, modelo a ser mantido.</li>
                                        <li style="margin-bottom: 10px;"><strong>Satisfa√ß√£o Institucional:</strong> ${Math.round((avaliacoesPositivasEscola / totalRespostasValidas) * 100)}% de satisfa√ß√£o com a escola demonstra boa adapta√ß√£o dos estudantes.</li>
                                        <li style="margin-bottom: 10px;"><strong>Disciplina Destaque:</strong> ${melhorDisciplina} apresenta ${Math.round(melhorPercentual)}% de afinidade positiva, servindo como refer√™ncia pedag√≥gica.</li>
                                    </ul>
                                </div>
                                
                                <h3>üìã Recomenda√ß√µes Estrat√©gicas</h3>
                                <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
                                    <p style="margin-bottom: 15px; font-weight: bold; color: #1C355E;">Com base nesses dados, recomenda-se:</p>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        <li style="margin-bottom: 8px;"><strong>Monitoramento sistem√°tico</strong> dos indicadores em ciclos trimestrais;</li>
                                        <li style="margin-bottom: 8px;"><strong>Ado√ß√£o de pol√≠ticas de presen√ßa</strong> mais eficazes para reduzir faltas injustificadas;</li>
                                        <li style="margin-bottom: 8px;"><strong>Incentivo a pr√°ticas colaborativas</strong> e inclusivas no cotidiano escolar;</li>
                                        <li style="margin-bottom: 8px;"><strong>Implementa√ß√£o de estrat√©gias</strong> para melhoria da concentra√ß√£o em sala de aula;</li>
                                        <li style="margin-bottom: 8px;"><strong>Manuten√ß√£o e expans√£o</strong> das pr√°ticas pedag√≥gicas bem avaliadas;</li>
                                        <li style="margin-bottom: 8px;"><strong>Fortalecimento do trabalho</strong> do segundo professor como refer√™ncia de inclus√£o.</li>
                                    </ul>
                                </div>
                                
                                <h3>üéØ Considera√ß√µes Finais</h3>
                                <p style="text-align: justify; line-height: 1.8; font-size: 1.05rem; background: #e8f2ff; padding: 20px; border-radius: 10px; border-left: 4px solid #1C355E;">
                                    Este relat√≥rio visa subsidiar a tomada de decis√µes da equipe gestora, promovendo uma escola mais acolhedora, eficiente e centrada no estudante. Os dados revelam um ambiente escolar com bases s√≥lidas de respeito e satisfa√ß√£o, mas com oportunidades claras de melhoria na frequ√™ncia e concentra√ß√£o. A continuidade do trabalho de inclus√£o e o monitoramento sistem√°tico dos indicadores s√£o fundamentais para o aprimoramento cont√≠nuo da qualidade educacional.
                                </p>
                                
                                <div style="text-align: center; margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <p style="margin: 0; font-style: italic; color: #666;">
                                        <strong>Relat√≥rio gerado em:</strong> ${new Date().toLocaleString('pt-BR')}<br>
                                        <strong>Pr√≥xima avalia√ß√£o sugerida:</strong> ${new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')} (90 dias)
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p><strong>¬© 2025 Luiz Alessandro Tecnologia Educacional</strong></p>
                            <p>Desenvolvido por Luiz Alessandro da Silva</p>
                            <p>Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Abrir relat√≥rio em nova aba
            const newWindow = window.open('', '_blank');
            newWindow.document.write(reportHTML);
            newWindow.document.close();
        }

        function setupHoverCards() {
            const hoverCards = document.querySelectorAll('.hover-card');
            let currentTooltip = null;
            let hoverTimeout = null;
            let hideTimeout = null;

            hoverCards.forEach(card => {
                card.addEventListener('mouseenter', function(e) {
                    // Limpar timeouts anteriores
                    if (hoverTimeout) clearTimeout(hoverTimeout);
                    if (hideTimeout) clearTimeout(hideTimeout);
                    
                    const hoverData = this.getAttribute('data-hover');
                    
                    // Se j√° existe um tooltip, apenas atualizar conte√∫do
                    if (currentTooltip) {
                        currentTooltip.innerHTML = hoverData;
                        positionTooltip(currentTooltip, this);
                        currentTooltip.classList.add('show');
                        return;
                    }
                    
                    // Criar novo tooltip com delay suave
                    hoverTimeout = setTimeout(() => {
                        // Remover tooltip anterior se existir
                        if (currentTooltip) {
                            currentTooltip.remove();
                        }
                        
                        // Criar novo tooltip
                        const tooltip = document.createElement('div');
                        tooltip.className = 'hover-tooltip';
                        tooltip.innerHTML = hoverData;
                        
                        // Adicionar ao DOM primeiro (invis√≠vel)
                        document.body.appendChild(tooltip);
                        
                        // Posicionar tooltip
                        positionTooltip(tooltip, this);
                        
                        // Mostrar tooltip com anima√ß√£o suave
                        requestAnimationFrame(() => {
                            tooltip.classList.add('show');
                        });
                        
                        currentTooltip = tooltip;
                    }, 200); // Delay de 200ms para evitar tooltips desnecess√°rios
                });
                
                card.addEventListener('mouseleave', function() {
                    // Limpar timeout de cria√ß√£o se ainda n√£o executou
                    if (hoverTimeout) {
                        clearTimeout(hoverTimeout);
                        hoverTimeout = null;
                    }
                    
                    if (currentTooltip) {
                        currentTooltip.classList.remove('show');
                        
                        // Remover tooltip ap√≥s anima√ß√£o
                        hideTimeout = setTimeout(() => {
                            if (currentTooltip) {
                                currentTooltip.remove();
                                currentTooltip = null;
                            }
                        }, 300); // Tempo da anima√ß√£o CSS
                    }
                });
            });
            
            // Fun√ß√£o auxiliar para posicionar tooltip
            function positionTooltip(tooltip, card) {
                const cardRect = card.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // Posicionar acima do cart√£o por padr√£o
                let top = cardRect.top - tooltipRect.height - 15;
                let left = cardRect.left + (cardRect.width / 2) - (tooltipRect.width / 2);
                
                // Verificar se tooltip sai da parte superior da tela
                if (top < 10) {
                    // Posicionar abaixo do cart√£o
                    top = cardRect.bottom + 15;
                    // Inverter a seta do tooltip
                    tooltip.style.setProperty('--arrow-position', 'top');
                } else {
                    tooltip.style.setProperty('--arrow-position', 'bottom');
                }
                
                // Ajustar posi√ß√£o horizontal se sair da tela
                if (left < 10) {
                    left = 10;
                } else if (left + tooltipRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipRect.width - 10;
                }
                
                tooltip.style.top = (top + window.scrollY) + 'px';
                tooltip.style.left = left + 'px';
            }
        }

        function printReport() {
            // Criar uma nova janela para impress√£o
            const printWindow = window.open('', '_blank');
            const reportContent = document.getElementById('reportContent').innerHTML;
            
            // Obter estat√≠sticas principais para incluir no relat√≥rio
            const stats = {
                totalRespostas: processedData.totalRespostas,
                disciplinasAvaliadas: Object.keys(processedData.disciplinas).length,
                comentarios: processedData.comentarios.sentimentos.length + processedData.comentarios.situacoesProfessores.length
            };
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Relat√≥rio de Pesquisa Educacional</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            margin: 20px;
                            color: #333;
                        }
                        h1, h2, h3, h4 {
                            color: #2c3e50;
                        }
                        h1 {
                            text-align: center;
                            border-bottom: 3px solid #3498db;
                            padding-bottom: 10px;
                        }
                        .stats-summary {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 20px 0;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin: 15px 0;
                        }
                        .stat-item {
                            text-align: center;
                            padding: 10px;
                            background: white;
                            border-radius: 5px;
                            border: 1px solid #ddd;
                        }
                        .stat-number {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #3498db;
                        }
                        ul {
                            padding-left: 20px;
                        }
                        li {
                            margin-bottom: 8px;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 0.9em;
                            color: #666;
                            border-top: 1px solid #ddd;
                            padding-top: 15px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üìä Relat√≥rio de Pesquisa Educacional</h1>
                    <p style="text-align: center; font-style: italic;">Escola Hon√≥rio Miranda - ${new Date().toLocaleDateString('pt-BR')}</p>
                    
                    <div class="stats-summary">
                        <h3>üìä Resumo dos Dados</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">${stats.totalRespostas}</div>
                                <div>Total de Respostas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${stats.disciplinasAvaliadas}</div>
                                <div>Disciplinas Avaliadas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${stats.comentarios}</div>
                                <div>Coment√°rios Coletados</div>
                            </div>
                        </div>
                    </div>
                    
                    ${reportContent}
                    
                    <div class="footer">
                        <p><strong>¬© 2025 Luiz Alessandro Tecnologia Educacional</strong></p>
                        <p>Desenvolvido por Luiz Alessandro da Silva</p>
                        <p>Relat√≥rio gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>

